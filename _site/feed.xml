<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="https://thefirstwind.github.io//feed.xml" rel="self" type="application/atom+xml" /><link href="https://thefirstwind.github.io//" rel="alternate" type="text/html" /><updated>2020-11-03T17:43:20+08:00</updated><id>https://thefirstwind.github.io//feed.xml</id><title type="html">kei’s blog</title><subtitle>An amazing website of kei.</subtitle><author><name>kei gosling</name></author><entry><title type="html">订单与结算逻辑 后台batch</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E5%90%8E%E5%8F%B0batch/" rel="alternate" type="text/html" title="订单与结算逻辑 后台batch" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E5%90%8E%E5%8F%B0batch</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E5%90%8E%E5%8F%B0batch/"># 01. 订单与结算逻辑.结算与支付

&gt; 
- **时间**：2018年8月23日

@[订单, 结算逻辑]

-------------------

[TOC]

## 数据字典


### 系统角色
| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 院内订单类型
| 订单类型  | 前提条件 |  工资计算说明|
| :-------- |:--------| :--: |
| 1对1订单 | 院内有机动护工 | 系统计算、每日按照比例分配 |
| 1对多订单 | 当前病区绑定了护工 |  系统计算、每日按照比例分配   |
| 团队制订单| 当前病区支持团队制 | 不统计报表  |
| 单项订单 |擎浩医院管理老师| 待定 |

### 订单状态
| 状态  | 状态名称 |  说明|
| :-------- |:--------| :-- |
| 0  | 无状态 | 空状态，冗余字段 |
| 1  | 预约中 | 院外抢单用状态 |
| 2  | 预约成功 | POS机管理老师代接单，并且派工之后的状态 |
| 3  | 待支付（在2小时内付款，超时被取消） | 院内订单下单之后的状态 |
| 4  | 已支付（支付成功） | 支付成功的状态 |
| 5  | 待服务（等待上门服务，计时） | 支付成功之后，2个小时之内保持待服务状态 |
| 6  | 服务中（服务进度） | 支付成功之后，2个小时之后进入服务中状态 |
| 7  | 待结算 | 用户(POS机)发起结算 （等待结算并提示用户结算，超时关闭订单）|
| 8  | 已完成 | 用户(POS机)发起结算之后，如果判断退款成功，状态变为完成 |
| 9  | 待评价 | 冗余状态 |
| 10  | 已评价 | 用户评价完成之后 |
| 11  | 已取消（取消成功） | 超时支付，自动变为取消|
| 12  | 申请退款（发起退款申请） | 待服务状态，申请全额退款的状态 |
| 13  | 退款中（退款已受理，并进行退款程序） | 发起退款的状态 |
| 14  | 退款成功 （退款额转入用户账户） | 用户(POS机)发起退款，如果确认退款成功，状态变为退款成功 |
| 15  | 退款失败（提示失败原因） | 用户(POS机)发起退款，如果确认退款失败，状态变为退款失败 |
| 16  | 变更待服务 | 发起订单变更之后的状态 |
| 17  | 结算中 | 用户(POS机)发起结算，状态变为结算中 |
| 18  | 结算完成 | 用户(POS机)发起结算，如果确认结算成功，状态变为结算完成 |
| 19  | 结算失败 | 用户(POS机)发起结算，如果确认结算失败，状态变为结算失败 |



## 数据库设计

### 订单主表
```
说明：
1 插入条件：用户下单、POS机下单、发生支付的订单变更
2 修改条件：支付、超时未支付、补录患者信息、订单变更、订单结算（用户或者POS发起的结算）、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| ordid|String|必须| 订单ID|1804050053004W|
| uopid|String|必须| 患者openid| ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| tradeno|String|必须| 支付UID| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| ptorduid|String|必须| 患者姓名| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| rlnm|String|必须| 父订单号，续单用，初始值为其本身如果有续单或者纠纷负单则为其父单orduid| 王根娣|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| statncd|String|必须| 护工站代码| 31010700052|
| statnnm|String|必须| 护工站| 上海市同济大学附属同济医院(同济医院)|
| amount|Integer|必须| 订单初始预收金额| 90000|
| ordlessfee|Integer|| 订单剩余金额| 0|
| status1|Integer|| 0 无状态  &lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功 &lt;br/&gt;3 待支付（在2小时内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成 &lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt; 11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因） &lt;br/&gt;16 变更待服务 &lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 &lt;br/&gt;| 5|
| status1nm|String|| 同上| 待服务|
| usrconftm|datetime||用户确认完成时间| 2018-04-14 14:54:50|
| splitsttlfg|Integer|| 拆分结算标识0：未拆分结算，1已拆分结算| 0|
| continufee|Integer|| 结转金额| 0|
| chgstatus|Integer||  1 变更未开始 &lt;br/&gt;2 变更已开始&lt;br/&gt;| 0|
| sttlefg|Integer|| 结算标识：给用户退款订单结算掉，成功结算更新 0默认,1已结算| 0|



### 订单详情表
```
说明：
1 插入条件：用户下单、POS机下单、不发生支付的订单变更
2 修改条件：订单变更、订单结算（用户或POS发起的订单结算）、护工结束服务、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| wuid|String|必须| 护工Uid| WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| wstatncd|String|必须| 所属网点 该护工所属网点|31010700052 |
| statncd|String|必须|服务网点 订单服务网点（非网点，没有代码） |31010700052 |
| hospnm|String|必须| 服务医院 医院名称| 上海市同济大学附属同济医院(同济医院)|
| sitmid|Integer|必须| 服务项目 当ordtp属于院内时| |
| svctp|String|必须| 交易号| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| unitprice|Integer|必须|  服务项目单价| 9000|
| amount|Integer|必须| 服务项目小计 服务项目单价 X 服务天数（精算）| 90000|
| adjustday|decimal(4,2)|| 调整天数 -0.5 0  0.5 三个值，在最后一天结算| 0|
| status1|Integer|| 0 无状态&lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功&lt;br/&gt;3 待支付（在15分钟内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）.&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成&lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt;11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因）&lt;br/&gt;16 变更待服务&lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 | 5|
| status1nm|String||同上 | 待服务|
| status3|Integer|| 状态-完成 0 无状态 1 完成 | 1|
| status3nm|String|| 状态-完成-说明 保存护工的做工状态 | 完成|
| factsvcfg|Integer|| 子单实际服务标识：0 是默认，1 是结算退款记录， 2 是退款记录{tips:该子单是否是实际服务单} | 0|



### 支付信息表
```
说明：
1 插入条件：支付、退款、结算等，有金额流转的情况
2 修改条件：支付成功后状态 paid状态更新，结算申请发起、结算状态更新、退款状态发起、退款状态更新。
3 终止条件：超时未支付、支付完成、结算完成、退款完成、
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| tradeno|String|必须| 支付订单号 tr+&quot;-&quot;+36位UUID（带-）&lt;br/&gt;微信线上支付 pt开头&lt;br/&gt;微信扫码支付 td开头&lt;br/&gt;银联支付 tr开头|TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| uopid|String|| 用户UID 支付者UID，不一定是被服务的患者|ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| fopid|String|| 推荐者UID 推荐者UID||
| ttype|Integer|| 订单类型 1医院 2医院单项 3居家|1|
| paid|Integer|| 是否已支付 &lt;br/&gt;0 未支付 &lt;br/&gt;1 线上支付 &lt;br/&gt;2 现金支付&lt;br/&gt;3 退款成功&lt;br/&gt;4 退款失败|1|
| paidtm|datetime|| 支付时间 非0的时候 才有值|2018-04-05 10:58:56|
| payment|Integer|| 支付方式 &lt;br/&gt;1 微信 &lt;br/&gt;2 刷卡（借记卡） &lt;br/&gt;3 刷卡（信用卡） &lt;br/&gt;4 现金（线下支付）&lt;br/&gt; 5 支付宝|1|
| amount|Integer|| 支付金额|90000|
| outorderno|String|| 外部订单号 外部订单号||
| outtransno|String|| 外部流水号 外部流水号|4200000095201804052560224795|
| resttlfg|Integer|| 预结算标志位：0未结算，1已结算||
| sttlfg|Integer|| 已结算标志 0未结算 1 已结算||
| sttlamt|Integer|| 结算金额||
| invoicetm|datetime|| 预分账标志位||
| reinvfg|Integer|| 分账标志||
| invoicefg|Integer|| ||
| refund|Integer|| 退款标志 现阶段价格统一。&lt;br/&gt;该字段为空，当每个省价格不同时，会用到。&lt;br/&gt;0是付款 1是退款|0|
| cardNo|String|| 银联支付用字段: 支付时所用的卡号(该字段当银联支付退款时使用)||
| transChnName|String|| 支付渠道名称||
| transEngName|String|| 支付渠道||
| refNo|String|| 银联支付用参考号||
| merchantNo|String|| 根据支付时的，商户编号||
| terminalNo|String|| pos机终端号码||
| traceNo|String|| 银联商务支付的记录号(每一个pos机从1开始计数)||



### 日结表
```
说明：
1 插入条件：开始服务的订单，每日12:30/23:30 进行结算
2 修改条件：无
3 终止条件：预付款消耗完为止
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| daysttuid|String|必须| 日结算UID|DST_VwACGXWSvbwTfEm9I_6dPyvWKkw2|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| porduid|String|必须| 母单orduid| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| sttdate|date|必须| 结算日期| 2018-04-05|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| daysttfee|Integer|| 日结算金额|9000|
| lessordfee|Integer|| 订单剩余金额(结余金额)|81000|
| daystttm|datetime|| 结算时间|2018-04-09 23:30:00|
| unitprice|Integer|| 单价 | 9000 |
| statncd|String|| 做单护工站 | 31010700052 |
| plusfee|String|| 增收 | 450 |
| wrkfee|String|| 护工工资 | 5400 |
| hospfee|String|| 医院管理费 | 900 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 2033 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 100 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| refundfee|String|| 退款金额 | 0 |



### 结算表
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| statncd|String|必须| 需求方所在护工站，如果院外非网点或居家为空|31010700052|
| wstatncd|String|必须| 护工所在护工站|31010700052|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| sttamount|Integer|必须| 结算金额(合算=医院管理费+护工工资+毛利润)|90000|
| unitprice|Integer|必须| 单价 护工身价*系数（目前100%）+保险 | 9000 |
| svcday|Integer|必须| 服务天数 | 10 |
| plusfee|String|| 增收 | 4500 |
| wrkfee|String|| 护工工资 | 54000 |
| hospfee|String|| 医院管理费 | 9000 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 21383 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 1000 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| invoicefg|Integer|| 分账标识0未分账，1已分账 针对是否分账到qo_ord_fin_statn_invoice表而标识 | 1 |
| isdowrkfeefg|String|| 护工工资标识 | 1 |

### 护工站分账明细
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| finuid|String|必须| 利益分账UID|FI_5NN3QewfIAJPKvTANe2xwG8nPFmUM|
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| requirstatncd|String|必须| 发单方statncd|31010700052|
| requirfee|Integer|必须| 发单方收益|0|
| wrkstatncd|String|必须| 派单方statncd|31010700052|
| wrkstatnfee|Integer|必须| 派单方收益|0|
| wrkfee|Integer|| 护工工资 | 54000 |
| hospfee|Integer|| 医院管理费 | 9000 |
| recomfee|Integer|| 推荐有奖金额 | 0 |
| insurfee|Integer|| 保险费 | 0 |
| plusfee|Integer|| 增收 | 0 |
| suplid|Integer|| 加盟商cd | 1 |
| suplfee|Integer|| 发单方加盟商收益 | 21383 |
| platfeee|Integer|| 平台遗留金额 | 0 |
| platamount|Integer|| 平台费用 | 0 |

### 护工工资表
```
说明：
1 插入条件：护工点击完成服务，+15天之后分账
2 修改条件：无
3 终止条件：护工点击完成服务，+15天之后分账
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| wiuid|String|必须| 收入UIDWI开头32位UUID|WI_DxhX4TG2DPkqMyCLLETeUoa4nbtJ0|
| wuid|String|必须| 护工编号UIDWK开头32位UUID|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| witp|Integer|必须| 收入类型收入类型 1 订单 2 推荐分享 3 奖励 4 积分换取 |1|
| income|Integer|必须| 收入单位是分 |54000|
| status|Integer|必须| 状态&lt;br/&gt;0 订单服务中 &lt;br/&gt;1 等待结算  &lt;br/&gt;2 系统审核中 &lt;br/&gt;9已生效&lt;br/&gt; (订单服务中状态为0，&lt;br/&gt;订单服务截止之间到但未被结算状态为1,&lt;br/&gt;订单被投诉 状态为2，&lt;br/&gt;订单结束并结算再加14天 状态为9，) |2|
| cashed|Integer|必须| 是否已提现0 未体现 1 已提现 |1|
| cashtm|DateTime|必须| 提现时间提现的时间 |2018-04-09 23:30:00|



## 订单状态变化与结算数据的流程
### 订单状态变化(时序图):
```sequence
用户端-&gt;[数据库]: 1 用户自主下单(院外订单)
用户端-&gt;[数据库]: 2 用户自主下单(院内订单)
POS机-&gt;[数据库]: POS机管理老师接单、并且派工
[批处理]-&gt;[数据库]: 2小时无人反映，取消订单
用户端-&gt;[数据库]: [￥支付 微信 ]
POS机-&gt;[数据库]: [￥收款：微信/支付宝/银行卡/现金]
[批处理]-&gt;[批处理]: 30分钟内不支付，支付状态超时
[批处理]--&gt;[数据库]: 取消订单
[批处理]-&gt;[批处理]: 支付成功之后，2小时内处于待服务状态，超过2小时进入服务中
[批处理]--&gt;[数据库]: 待服务-&gt;服务中
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结算
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```


## 后台批处理接口说明

### 01. 支付超时的处理
-  [http://localhost:8081/api/schd/orderCancelUnpaid](#)
&gt; 说明：
    1 清理超过2小时的订单未支付的订单
	2 订单变更的处理，当2个小时内不支付，已经申请变更的订单自动变成过期未支付状态
    3 每天 8-20点之间，每分钟执行


### 02. 订单变更审核超时的处理
-  [http://localhost:8081/api/schd/cancelUnaplyToUnPayOrd](#)
&gt; 说明：
	1 次日生效 24小时后 不审批 取消并且退款
	2 当日及时生效 6小时后 遍生效 取消并且退款

### 03. 订单变更待服务的处理
-  [http://localhost:8081/api/schd/orderChangeSerStart](#)
&gt; 说明：
	1 修改变更服务变成待服务(立即执行) 没有支付的订单变更
	2 只有审批通过的变更待服务才能进入服务状态，否者停留在永远待服务的状态
    3 每分钟执行

### 04. 退款给用户的处理（微信）
-  [http://localhost:8081/api/schd/orderRefundToUser](#)
&gt; 说明：
	1 判断订单状态为7，立即退款给用户
    2 每分钟执行

### 05. 退款给用户的处理（银联）
-  [http://localhost:8081/api/schd/doRefundToUserUpay](#)
&gt; 说明：
	1 判断订单状态为7，立即退款给用户
    2 每分钟执行

### 06. 待服务进入服务中(无需支付)
-  [http://localhost:8081/api/schd/orderWaitSerToSer](#)
&gt; 说明：
	1 订单支付成功2小时后，待服务进入服务中
    2 每分钟执行，订单支付时间到当前时间有2小时的订单


### 07. 变更待服务进入服务中(有支付)
-  [http://localhost:8081/api/schd/orderChangeWaitSerToSer](#)
&gt; 说明：
	1 变更订单的等待状态变成开始服务 有支付状态的订单变更
	2 只有审批通过的变更待服务才能进入服务状态，否者停留在永远待服务的状态
    3 每分钟执行，订单支付时间到当前时间有2小时的订单


### 08. 订单拆分
-  [http://localhost:8081/api/schd/finSplitSttle](#)
&gt; 说明：
    1 针对每个订单的拆分细则，拆分 护工工资、平台费、科室费、保险费、公司所得等费用

### 09. 分账给护工站
-  [http://localhost:8081/api/schd/finInvoiceToStatn](#)
&gt; 说明：
    1 针对每个订单的拆分细则，拆分 护工工资、平台费、科室费、保险费、公司所得等费用到具体的护工站

### 10. 日结脚本
-  [http://localhost:8081/api/schd/ordDayStt](#)
&gt; 说明：
    1 针对每个订单做当日结算，消耗当天费用，并且拆分 护工工资、平台费、科室费、保险费、公司所得等费用
    2 每天12:30 23:30 跑该脚本

### 11. 护工工资结算改变状态脚本
-  [http://localhost:8081/api/schd/doSettleWrkfee](#)
&gt; 说明：
    1 根据日结结果，计算每日护工工资
    2 每天1点15分 跑该脚本

### 12. 订单逾期脚本
-  [http://localhost:8081/api/schd/ordFinishStt](#)
&gt; 说明：
    1 结算到期订单用户未点击的订单 ，结算成逾期，并且释放床位
    2 每天1点30分 跑该脚本


### 13. 订单结算状态脚本
-  [http://localhost:8081/api/schd/doSttlement](#)
&gt; 说明：
    1 对于用户已经点击结算，护工已经点击结束服务的订单，跑的脚本
    2 分钟跑该脚本</content><author><name>kei gosling</name></author><summary type="html">01. 订单与结算逻辑.结算与支付</summary></entry><entry><title type="html">订单与结算逻辑 减免与优惠</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E5%87%8F%E5%85%8D%E4%B8%8E%E4%BC%98%E6%83%A0/" rel="alternate" type="text/html" title="订单与结算逻辑 减免与优惠" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E5%87%8F%E5%85%8D%E4%B8%8E%E4%BC%98%E6%83%A0</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E5%87%8F%E5%85%8D%E4%B8%8E%E4%BC%98%E6%83%A0/"># 04. 订单与结算逻辑.减免与优惠

&gt; 
- **时间**：2018年9月8日

@[订单, 结算逻辑,减免与优惠]

-------------------

[TOC]


## 减免与优惠业务范围
&gt; 1 订单类型： 服务中-&gt;结算申请

&gt; 2 适用场景：
 * 订单完结的时候，对订单结算金额 加减0.5天
 * 订单完结的时候，减免应结算的 平台管理费、医院管理费等费用

## 数据字典
### 系统角色
| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 院内订单类型
| 订单类型  | 前提条件 |  工资计算说明|
| :-------- |:--------| :--: |
| 1对1订单 | 院内有机动护工 | 系统计算、每日按照比例分配 |
| 1对多订单 | 当前病区绑定了护工 |  系统计算、每日按照比例分配   |
| 团队制订单| 当前病区支持团队制 | 不统计报表  |
| 单项订单 |擎浩医院管理老师| 待定 |

### 订单状态
| 状态  | 状态名称 |  说明|
| :-------- |:--------| :-- |
| 0  | 无状态 | 空状态，冗余字段 |
| 1  | 预约中 | 院外抢单用状态 |
| 2  | 预约成功 | POS机管理老师代接单，并且派工之后的状态 |
| 3  | 待支付（在2小时内付款，超时被取消） | 院内订单下单之后的状态 |
| 4  | 已支付（支付成功） | 支付成功的状态 |
| 5  | 待服务（等待上门服务，计时） | 支付成功之后，2个小时之内保持待服务状态 |
| 6  | 服务中（服务进度） | 支付成功之后，2个小时之后进入服务中状态 |
| 7  | 待结算 | 用户(POS机)发起结算 （等待结算并提示用户结算，超时关闭订单）|
| 8  | 已完成 | 用户(POS机)发起结算之后，如果判断退款成功，状态变为完成 |
| 9  | 待评价 | 冗余状态 |
| 10  | 已评价 | 用户评价完成之后 |
| 11  | 已取消（取消成功） | 超时支付，自动变为取消|
| 12  | 申请退款（发起退款申请） | 待服务状态，申请全额退款的状态 |
| 13  | 退款中（退款已受理，并进行退款程序） | 发起退款的状态 |
| 14  | 退款成功 （退款额转入用户账户） | 用户(POS机)发起退款，如果确认退款成功，状态变为退款成功 |
| 15  | 退款失败（提示失败原因） | 用户(POS机)发起退款，如果确认退款失败，状态变为退款失败 |
| 16  | 变更待服务 | 发起订单变更之后的状态 |
| 17  | 结算中 | 用户(POS机)发起结算，状态变为结算中 |
| 18  | 结算完成 | 用户(POS机)发起结算，如果确认结算成功，状态变为结算完成 |
| 19  | 结算失败 | 用户(POS机)发起结算，如果确认结算失败，状态变为结算失败 |



## 数据库设计

### 订单主表
```
说明：
1 插入条件：无
2 修改条件：结算申请，调整结算金额
3 终止条件：结算申请，调整结算金额
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| ordid|String|必须| 订单ID|1804050053004W|
| uopid|String|必须| 患者openid| ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| tradeno|String|必须| 支付UID| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| ptorduid|String|必须| 患者姓名| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| rlnm|String|必须| 父订单号，续单用，初始值为其本身如果有续单或者纠纷负单则为其父单orduid| 王根娣|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| statncd|String|必须| 护工站代码| 31010700052|
| statnnm|String|必须| 护工站| 上海市同济大学附属同济医院(同济医院)|
| amount|Integer|必须| 订单初始预收金额| 90000|
| ordlessfee|Integer|| 订单剩余金额| 0|
| status1|Integer|| 0 无状态  &lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功 &lt;br/&gt;3 待支付（在2小时内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成 &lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt; 11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因） &lt;br/&gt;16 变更待服务 &lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 &lt;br/&gt;| 5|
| status1nm|String|| 同上| 待服务|
| usrconftm|datetime||用户确认完成时间| 2018-04-14 14:54:50|
| splitsttlfg|Integer|| 拆分结算标识0：未拆分结算，1已拆分结算| 0|
| continufee|Integer|| 结转金额| 0|
| chgstatus|Integer||  1 变更未开始 &lt;br/&gt;2 变更已开始&lt;br/&gt;| 0|
| discfg|String||  优惠标识discfg：&lt;br/&gt;0：无优惠，&lt;br/&gt;1：全免，&lt;br/&gt;2：减免医院管理费，&lt;br/&gt;3：减免公司收入，&lt;br/&gt;4：减免增收,&lt;br/&gt;5：团队制减免| 0|
| discamount|Integer|| 优惠金额| 300|
| sttlefg|Integer|| 结算标识：给用户退款订单结算掉，成功结算更新 0默认,1已结算| 0|



### 订单详情表
```
说明：
1 插入条件：无
2 修改条件：结算申请，调整结算金额
3 终止条件：结算申请，调整结算金额
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| wuid|String|必须| 护工Uid| WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| wstatncd|String|必须| 所属网点 该护工所属网点|31010700052 |
| statncd|String|必须|服务网点 订单服务网点（非网点，没有代码） |31010700052 |
| hospnm|String|必须| 服务医院 医院名称| 上海市同济大学附属同济医院(同济医院)|
| sitmid|Integer|必须| 服务项目 当ordtp属于院内时| |
| svctp|String|必须| 交易号| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| unitprice|Integer|必须|  服务项目单价| 9000|
| amount|Integer|必须| 服务项目小计 服务项目单价 X 服务天数（精算）| 90000|
| adjustday|decimal(4,2)|| 调整天数 -0.5 0  0.5 三个值，在最后一天结算| 0|
| status1|Integer|| 0 无状态&lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功&lt;br/&gt;3 待支付（在15分钟内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）.&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成&lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt;11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因）&lt;br/&gt;16 变更待服务&lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 | 5|
| status1nm|String||同上 | 待服务|
| status3|Integer|| 状态-完成 0 无状态 1 完成 | 1|
| status3nm|String|| 状态-完成-说明 保存护工的做工状态 | 完成|
| factsvcfg|Integer|| 子单实际服务标识：0 是默认，1 是结算退款记录， 2 是退款记录{tips:该子单是否是实际服务单} | 0|



### 支付信息表
```
说明：
1 插入条件：支付、退款、结算等，有金额流转的情况
2 修改条件：支付成功后状态 paid状态更新，结算申请发起、结算状态更新、退款状态发起、退款状态更新。
3 终止条件：超时未支付、支付完成、结算完成、退款完成、
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| tradeno|String|必须| 支付订单号 tr+&quot;-&quot;+36位UUID（带-）&lt;br/&gt;微信线上支付 pt开头&lt;br/&gt;微信扫码支付 td开头&lt;br/&gt;银联支付 tr开头|TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| uopid|String|| 用户UID 支付者UID，不一定是被服务的患者|ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| fopid|String|| 推荐者UID 推荐者UID||
| ttype|Integer|| 订单类型 1医院 2医院单项 3居家|1|
| paid|Integer|| 是否已支付 &lt;br/&gt;0 未支付 &lt;br/&gt;1 线上支付 &lt;br/&gt;2 现金支付&lt;br/&gt;3 退款成功&lt;br/&gt;4 退款失败|1|
| paidtm|datetime|| 支付时间 非0的时候 才有值|2018-04-05 10:58:56|
| payment|Integer|| 支付方式 &lt;br/&gt;1 微信 &lt;br/&gt;2 刷卡（借记卡） &lt;br/&gt;3 刷卡（信用卡） &lt;br/&gt;4 现金（线下支付）&lt;br/&gt; 5 支付宝|1|
| amount|Integer|| 支付金额|90000|
| outorderno|String|| 外部订单号 外部订单号||
| outtransno|String|| 外部流水号 外部流水号|4200000095201804052560224795|
| resttlfg|Integer|| 预结算标志位：0未结算，1已结算||
| sttlfg|Integer|| 已结算标志 0未结算 1 已结算||
| sttlamt|Integer|| 结算金额||
| invoicetm|datetime|| 预分账标志位||
| reinvfg|Integer|| 分账标志||
| invoicefg|Integer|| ||
| refund|Integer|| 退款标志 现阶段价格统一。&lt;br/&gt;该字段为空，当每个省价格不同时，会用到。&lt;br/&gt;0是付款 1是退款|0|
| cardNo|String|| 银联支付用字段: 支付时所用的卡号(该字段当银联支付退款时使用)||
| transChnName|String|| 支付渠道名称||
| transEngName|String|| 支付渠道||
| refNo|String|| 银联支付用参考号||
| merchantNo|String|| 根据支付时的，商户编号||
| terminalNo|String|| pos机终端号码||
| traceNo|String|| 银联商务支付的记录号(每一个pos机从1开始计数)||



### 日结表
```
说明：
1 插入条件：开始服务的订单，每日12:30/23:30 进行结算
2 修改条件：无
3 终止条件：预付款消耗完为止
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| daysttuid|String|必须| 日结算UID|DST_VwACGXWSvbwTfEm9I_6dPyvWKkw2|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| porduid|String|必须| 母单orduid| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| sttdate|date|必须| 结算日期| 2018-04-05|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| daysttfee|Integer|| 日结算金额|9000|
| lessordfee|Integer|| 订单剩余金额(结余金额)|81000|
| daystttm|datetime|| 结算时间|2018-04-09 23:30:00|
| unitprice|Integer|| 单价 | 9000 |
| statncd|String|| 做单护工站 | 31010700052 |
| plusfee|String|| 增收 | 450 |
| wrkfee|String|| 护工工资 | 5400 |
| hospfee|String|| 医院管理费 | 900 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 2033 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 100 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| refundfee|String|| 退款金额 | 0 |



### 结算表
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| statncd|String|必须| 需求方所在护工站，如果院外非网点或居家为空|31010700052|
| wstatncd|String|必须| 护工所在护工站|31010700052|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| sttamount|Integer|必须| 结算金额(合算=医院管理费+护工工资+毛利润)|90000|
| unitprice|Integer|必须| 单价 护工身价*系数（目前100%）+保险 | 9000 |
| svcday|Integer|必须| 服务天数 | 10 |
| plusfee|String|| 增收 | 4500 |
| wrkfee|String|| 护工工资 | 54000 |
| hospfee|String|| 医院管理费 | 9000 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 21383 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 1000 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| invoicefg|Integer|| 分账标识0未分账，1已分账 针对是否分账到qo_ord_fin_statn_invoice表而标识 | 1 |
| isdowrkfeefg|String|| 护工工资标识 | 1 |

### 护工站分账明细
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| finuid|String|必须| 利益分账UID|FI_5NN3QewfIAJPKvTANe2xwG8nPFmUM|
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| requirstatncd|String|必须| 发单方statncd|31010700052|
| requirfee|Integer|必须| 发单方收益|0|
| wrkstatncd|String|必须| 派单方statncd|31010700052|
| wrkstatnfee|Integer|必须| 派单方收益|0|
| wrkfee|Integer|| 护工工资 | 54000 |
| hospfee|Integer|| 医院管理费 | 9000 |
| recomfee|Integer|| 推荐有奖金额 | 0 |
| insurfee|Integer|| 保险费 | 0 |
| plusfee|Integer|| 增收 | 0 |
| suplid|Integer|| 加盟商cd | 1 |
| suplfee|Integer|| 发单方加盟商收益 | 21383 |
| platfeee|Integer|| 平台遗留金额 | 0 |
| platamount|Integer|| 平台费用 | 0 |

### 护工工资表
```
说明：
1 插入条件：护工点击完成服务，+15天之后分账
2 修改条件：无
3 终止条件：护工点击完成服务，+15天之后分账
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| wiuid|String|必须| 收入UIDWI开头32位UUID|WI_DxhX4TG2DPkqMyCLLETeUoa4nbtJ0|
| wuid|String|必须| 护工编号UIDWK开头32位UUID|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| witp|Integer|必须| 收入类型收入类型 1 订单 2 推荐分享 3 奖励 4 积分换取 |1|
| income|Integer|必须| 收入单位是分 |54000|
| status|Integer|必须| 状态&lt;br/&gt;0 订单服务中 &lt;br/&gt;1 等待结算  &lt;br/&gt;2 系统审核中 &lt;br/&gt;9已生效&lt;br/&gt; (订单服务中状态为0，&lt;br/&gt;订单服务截止之间到但未被结算状态为1,&lt;br/&gt;订单被投诉 状态为2，&lt;br/&gt;订单结束并结算再加14天 状态为9，) |2|
| cashed|Integer|必须| 是否已提现0 未体现 1 已提现 |1|
| cashtm|DateTime|必须| 提现时间提现的时间 |2018-04-09 23:30:00|



## 订单减免的流程
### 加减0.5天的结算(时序图):
```sequence
POS机-&gt;[数据库]: 管理老师带用户发起结算申请、加减0.5天
[批处理]--&gt;[数据库]: 查找发起结算的订单
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[批处理]-&gt;[批处理]: 服务结束时间判断
[批处理]--&gt;用户端: 通知用户服务结束
[批处理]--&gt;护工端: 通知护工服务结束
护工端--&gt;[数据库]: 确认结算状态
用户端--&gt;[数据库]: 确认结算状态

```

### 优惠单的结算:
```sequence
POS机-&gt;[数据库]: 1 发起结算申请（无优惠)
POS机-&gt;[数据库]: 2 发起结算申请（全部费用免除)
POS机-&gt;[数据库]: 3 发起结算申请（减免医院管理费)
POS机-&gt;[数据库]: 4 发起结算申请（减免公司收入)
POS机-&gt;[数据库]: 5 发起结算申请（减免增收)
POS机-&gt;[数据库]: 6 发起结算申请（团队制减免)
[批处理]--&gt;[数据库]: 查找发起结算的订单
[[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[批处理]--&gt;用户端: 通知用户服务已开始
[批处理]--&gt;护工端: 通知旧护工服务已结束
[批处理]--&gt;护工端: 通知新护工服务已开始
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```</content><author><name>kei gosling</name></author><summary type="html">04. 订单与结算逻辑.减免与优惠</summary></entry><entry><title type="html">订单与结算逻辑 代下单</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E4%BB%A3%E4%B8%8B%E5%8D%95/" rel="alternate" type="text/html" title="订单与结算逻辑 代下单" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E4%BB%A3%E4%B8%8B%E5%8D%95</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E4%BB%A3%E4%B8%8B%E5%8D%95/"># 01. 订单与结算逻辑.结算与支付

&gt; 
- **时间**：2018年8月23日

@[订单, 结算逻辑]

-------------------

[TOC]

## 数据字典


### 系统角色
| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 院内订单类型
| 订单类型  | 前提条件 |  工资计算说明|
| :-------- |:--------| :--: |
| 1对1订单 | 院内有机动护工 | 系统计算、每日按照比例分配 |
| 1对多订单 | 当前病区绑定了护工 |  系统计算、每日按照比例分配   |
| 团队制订单| 当前病区支持团队制 | 不统计报表  |
| 单项订单 |擎浩医院管理老师| 待定 |

### 订单状态
| 状态  | 状态名称 |  说明|
| :-------- |:--------| :-- |
| 0  | 无状态 | 空状态，冗余字段 |
| 1  | 预约中 | 院外抢单用状态 |
| 2  | 预约成功 | POS机管理老师代接单，并且派工之后的状态 |
| 3  | 待支付（在2小时内付款，超时被取消） | 院内订单下单之后的状态 |
| 4  | 已支付（支付成功） | 支付成功的状态 |
| 5  | 待服务（等待上门服务，计时） | 支付成功之后，2个小时之内保持待服务状态 |
| 6  | 服务中（服务进度） | 支付成功之后，2个小时之后进入服务中状态 |
| 7  | 待结算 | 用户(POS机)发起结算 （等待结算并提示用户结算，超时关闭订单）|
| 8  | 已完成 | 用户(POS机)发起结算之后，如果判断退款成功，状态变为完成 |
| 9  | 待评价 | 冗余状态 |
| 10  | 已评价 | 用户评价完成之后 |
| 11  | 已取消（取消成功） | 超时支付，自动变为取消|
| 12  | 申请退款（发起退款申请） | 待服务状态，申请全额退款的状态 |
| 13  | 退款中（退款已受理，并进行退款程序） | 发起退款的状态 |
| 14  | 退款成功 （退款额转入用户账户） | 用户(POS机)发起退款，如果确认退款成功，状态变为退款成功 |
| 15  | 退款失败（提示失败原因） | 用户(POS机)发起退款，如果确认退款失败，状态变为退款失败 |
| 16  | 变更待服务 | 发起订单变更之后的状态 |
| 17  | 结算中 | 用户(POS机)发起结算，状态变为结算中 |
| 18  | 结算完成 | 用户(POS机)发起结算，如果确认结算成功，状态变为结算完成 |
| 19  | 结算失败 | 用户(POS机)发起结算，如果确认结算失败，状态变为结算失败 |



## 数据库设计

### 订单主表
```
说明：
1 插入条件：用户下单、POS机下单、发生支付的订单变更
2 修改条件：支付、超时未支付、补录患者信息、订单变更、订单结算（用户或者POS发起的结算）、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| ordid|String|必须| 订单ID|1804050053004W|
| uopid|String|必须| 患者openid| ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| tradeno|String|必须| 支付UID| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| ptorduid|String|必须| 患者姓名| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| rlnm|String|必须| 父订单号，续单用，初始值为其本身如果有续单或者纠纷负单则为其父单orduid| 王根娣|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| statncd|String|必须| 护工站代码| 31010700052|
| statnnm|String|必须| 护工站| 上海市同济大学附属同济医院(同济医院)|
| amount|Integer|必须| 订单初始预收金额| 90000|
| ordlessfee|Integer|| 订单剩余金额| 0|
| status1|Integer|| 0 无状态  &lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功 &lt;br/&gt;3 待支付（在2小时内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成 &lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt; 11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因） &lt;br/&gt;16 变更待服务 &lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 &lt;br/&gt;| 5|
| status1nm|String|| 同上| 待服务|
| usrconftm|datetime||用户确认完成时间| 2018-04-14 14:54:50|
| splitsttlfg|Integer|| 拆分结算标识0：未拆分结算，1已拆分结算| 0|
| continufee|Integer|| 结转金额| 0|
| chgstatus|Integer||  1 变更未开始 &lt;br/&gt;2 变更已开始&lt;br/&gt;| 0|
| sttlefg|Integer|| 结算标识：给用户退款订单结算掉，成功结算更新 0默认,1已结算| 0|



### 订单详情表
```
说明：
1 插入条件：用户下单、POS机下单、不发生支付的订单变更
2 修改条件：订单变更、订单结算（用户或POS发起的订单结算）、护工结束服务、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| wuid|String|必须| 护工Uid| WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| wstatncd|String|必须| 所属网点 该护工所属网点|31010700052 |
| statncd|String|必须|服务网点 订单服务网点（非网点，没有代码） |31010700052 |
| hospnm|String|必须| 服务医院 医院名称| 上海市同济大学附属同济医院(同济医院)|
| sitmid|Integer|必须| 服务项目 当ordtp属于院内时| |
| svctp|String|必须| 交易号| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| unitprice|Integer|必须|  服务项目单价| 9000|
| amount|Integer|必须| 服务项目小计 服务项目单价 X 服务天数（精算）| 90000|
| adjustday|decimal(4,2)|| 调整天数 -0.5 0  0.5 三个值，在最后一天结算| 0|
| status1|Integer|| 0 无状态&lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功&lt;br/&gt;3 待支付（在15分钟内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）.&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成&lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt;11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因）&lt;br/&gt;16 变更待服务&lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 | 5|
| status1nm|String||同上 | 待服务|
| status3|Integer|| 状态-完成 0 无状态 1 完成 | 1|
| status3nm|String|| 状态-完成-说明 保存护工的做工状态 | 完成|
| factsvcfg|Integer|| 子单实际服务标识：0 是默认，1 是结算退款记录， 2 是退款记录{tips:该子单是否是实际服务单} | 0|



### 支付信息表
```
说明：
1 插入条件：支付、退款、结算等，有金额流转的情况
2 修改条件：支付成功后状态 paid状态更新，结算申请发起、结算状态更新、退款状态发起、退款状态更新。
3 终止条件：超时未支付、支付完成、结算完成、退款完成、
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| tradeno|String|必须| 支付订单号 tr+&quot;-&quot;+36位UUID（带-）&lt;br/&gt;微信线上支付 pt开头&lt;br/&gt;微信扫码支付 td开头&lt;br/&gt;银联支付 tr开头|TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| uopid|String|| 用户UID 支付者UID，不一定是被服务的患者|ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| fopid|String|| 推荐者UID 推荐者UID||
| ttype|Integer|| 订单类型 1医院 2医院单项 3居家|1|
| paid|Integer|| 是否已支付 &lt;br/&gt;0 未支付 &lt;br/&gt;1 线上支付 &lt;br/&gt;2 现金支付&lt;br/&gt;3 退款成功&lt;br/&gt;4 退款失败|1|
| paidtm|datetime|| 支付时间 非0的时候 才有值|2018-04-05 10:58:56|
| payment|Integer|| 支付方式 &lt;br/&gt;1 微信 &lt;br/&gt;2 刷卡（借记卡） &lt;br/&gt;3 刷卡（信用卡） &lt;br/&gt;4 现金（线下支付）&lt;br/&gt; 5 支付宝|1|
| amount|Integer|| 支付金额|90000|
| outorderno|String|| 外部订单号 外部订单号||
| outtransno|String|| 外部流水号 外部流水号|4200000095201804052560224795|
| resttlfg|Integer|| 预结算标志位：0未结算，1已结算||
| sttlfg|Integer|| 已结算标志 0未结算 1 已结算||
| sttlamt|Integer|| 结算金额||
| invoicetm|datetime|| 预分账标志位||
| reinvfg|Integer|| 分账标志||
| invoicefg|Integer|| ||
| refund|Integer|| 退款标志 现阶段价格统一。&lt;br/&gt;该字段为空，当每个省价格不同时，会用到。&lt;br/&gt;0是付款 1是退款|0|
| cardNo|String|| 银联支付用字段: 支付时所用的卡号(该字段当银联支付退款时使用)||
| transChnName|String|| 支付渠道名称||
| transEngName|String|| 支付渠道||
| refNo|String|| 银联支付用参考号||
| merchantNo|String|| 根据支付时的，商户编号||
| terminalNo|String|| pos机终端号码||
| traceNo|String|| 银联商务支付的记录号(每一个pos机从1开始计数)||



### 日结表
```
说明：
1 插入条件：开始服务的订单，每日12:30/23:30 进行结算
2 修改条件：无
3 终止条件：预付款消耗完为止
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| daysttuid|String|必须| 日结算UID|DST_VwACGXWSvbwTfEm9I_6dPyvWKkw2|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| porduid|String|必须| 母单orduid| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| sttdate|date|必须| 结算日期| 2018-04-05|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| daysttfee|Integer|| 日结算金额|9000|
| lessordfee|Integer|| 订单剩余金额(结余金额)|81000|
| daystttm|datetime|| 结算时间|2018-04-09 23:30:00|
| unitprice|Integer|| 单价 | 9000 |
| statncd|String|| 做单护工站 | 31010700052 |
| plusfee|String|| 增收 | 450 |
| wrkfee|String|| 护工工资 | 5400 |
| hospfee|String|| 医院管理费 | 900 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 2033 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 100 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| refundfee|String|| 退款金额 | 0 |



### 结算表
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| statncd|String|必须| 需求方所在护工站，如果院外非网点或居家为空|31010700052|
| wstatncd|String|必须| 护工所在护工站|31010700052|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| sttamount|Integer|必须| 结算金额(合算=医院管理费+护工工资+毛利润)|90000|
| unitprice|Integer|必须| 单价 护工身价*系数（目前100%）+保险 | 9000 |
| svcday|Integer|必须| 服务天数 | 10 |
| plusfee|String|| 增收 | 4500 |
| wrkfee|String|| 护工工资 | 54000 |
| hospfee|String|| 医院管理费 | 9000 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 21383 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 1000 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| invoicefg|Integer|| 分账标识0未分账，1已分账 针对是否分账到qo_ord_fin_statn_invoice表而标识 | 1 |
| isdowrkfeefg|String|| 护工工资标识 | 1 |

### 护工站分账明细
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| finuid|String|必须| 利益分账UID|FI_5NN3QewfIAJPKvTANe2xwG8nPFmUM|
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| requirstatncd|String|必须| 发单方statncd|31010700052|
| requirfee|Integer|必须| 发单方收益|0|
| wrkstatncd|String|必须| 派单方statncd|31010700052|
| wrkstatnfee|Integer|必须| 派单方收益|0|
| wrkfee|Integer|| 护工工资 | 54000 |
| hospfee|Integer|| 医院管理费 | 9000 |
| recomfee|Integer|| 推荐有奖金额 | 0 |
| insurfee|Integer|| 保险费 | 0 |
| plusfee|Integer|| 增收 | 0 |
| suplid|Integer|| 加盟商cd | 1 |
| suplfee|Integer|| 发单方加盟商收益 | 21383 |
| platfeee|Integer|| 平台遗留金额 | 0 |
| platamount|Integer|| 平台费用 | 0 |

### 护工工资表
```
说明：
1 插入条件：护工点击完成服务，+15天之后分账
2 修改条件：无
3 终止条件：护工点击完成服务，+15天之后分账
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| wiuid|String|必须| 收入UIDWI开头32位UUID|WI_DxhX4TG2DPkqMyCLLETeUoa4nbtJ0|
| wuid|String|必须| 护工编号UIDWK开头32位UUID|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| witp|Integer|必须| 收入类型收入类型 1 订单 2 推荐分享 3 奖励 4 积分换取 |1|
| income|Integer|必须| 收入单位是分 |54000|
| status|Integer|必须| 状态&lt;br/&gt;0 订单服务中 &lt;br/&gt;1 等待结算  &lt;br/&gt;2 系统审核中 &lt;br/&gt;9已生效&lt;br/&gt; (订单服务中状态为0，&lt;br/&gt;订单服务截止之间到但未被结算状态为1,&lt;br/&gt;订单被投诉 状态为2，&lt;br/&gt;订单结束并结算再加14天 状态为9，) |2|
| cashed|Integer|必须| 是否已提现0 未体现 1 已提现 |1|
| cashtm|DateTime|必须| 提现时间提现的时间 |2018-04-09 23:30:00|



## 订单状态变化与结算数据的流程
### 订单状态变化(时序图):
```sequence
用户端-&gt;[数据库]: 1 用户自主下单(院外订单)
用户端-&gt;[数据库]: 2 用户自主下单(院内订单)
POS机-&gt;[数据库]: POS机管理老师接单、并且派工
[批处理]-&gt;[数据库]: 2小时无人反映，取消订单
用户端-&gt;[数据库]: [￥支付 微信 ]
POS机-&gt;[数据库]: [￥收款：微信/支付宝/银行卡/现金]
[批处理]-&gt;[批处理]: 30分钟内不支付，支付状态超时
[批处理]--&gt;[数据库]: 取消订单
[批处理]-&gt;[批处理]: 支付成功之后，2小时内处于待服务状态，超过2小时进入服务中
[批处理]--&gt;[数据库]: 待服务-&gt;服务中
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结算
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```


## 后台批处理接口说明

### 01. 支付超时的处理
-  [http://localhost:8081/api/schd/orderCancelUnpaid](#)
&gt; 说明：
    1 清理超过2小时的订单未支付的订单
	2 订单变更的处理，当2个小时内不支付，已经申请变更的订单自动变成过期未支付状态
    3 每天 8-20点之间，每分钟执行


### 02. 订单变更审核超时的处理
-  [http://localhost:8081/api/schd/cancelUnaplyToUnPayOrd](#)
&gt; 说明：
	1 次日生效 24小时后 不审批 取消并且退款
	2 当日及时生效 6小时后 遍生效 取消并且退款

### 03. 订单变更待服务的处理
-  [http://localhost:8081/api/schd/orderChangeSerStart](#)
&gt; 说明：
	1 修改变更服务变成待服务(立即执行) 没有支付的订单变更
	2 只有审批通过的变更待服务才能进入服务状态，否者停留在永远待服务的状态
    3 每分钟执行

### 04. 退款给用户的处理（微信）
-  [http://localhost:8081/api/schd/orderRefundToUser](#)
&gt; 说明：
	1 判断订单状态为7，立即退款给用户
    2 每分钟执行

### 05. 退款给用户的处理（银联）
-  [http://localhost:8081/api/schd/doRefundToUserUpay](#)
&gt; 说明：
	1 判断订单状态为7，立即退款给用户
    2 每分钟执行

### 06. 待服务进入服务中(无需支付)
-  [http://localhost:8081/api/schd/orderWaitSerToSer](#)
&gt; 说明：
	1 订单支付成功2小时后，待服务进入服务中
    2 每分钟执行，订单支付时间到当前时间有2小时的订单


### 07. 变更待服务进入服务中(有支付)
-  [http://localhost:8081/api/schd/orderChangeWaitSerToSer](#)
&gt; 说明：
	1 变更订单的等待状态变成开始服务 有支付状态的订单变更
	2 只有审批通过的变更待服务才能进入服务状态，否者停留在永远待服务的状态
    3 每分钟执行，订单支付时间到当前时间有2小时的订单


### 08. 订单拆分
-  [http://localhost:8081/api/schd/finSplitSttle](#)
&gt; 说明：
    1 针对每个订单的拆分细则，拆分 护工工资、平台费、科室费、保险费、公司所得等费用

### 09. 分账给护工站
-  [http://localhost:8081/api/schd/finInvoiceToStatn](#)
&gt; 说明：
    1 针对每个订单的拆分细则，拆分 护工工资、平台费、科室费、保险费、公司所得等费用到具体的护工站

### 10. 日结脚本
-  [http://localhost:8081/api/schd/ordDayStt](#)
&gt; 说明：
    1 针对每个订单做当日结算，消耗当天费用，并且拆分 护工工资、平台费、科室费、保险费、公司所得等费用
    2 每天12:30 23:30 跑该脚本

### 11. 护工工资结算改变状态脚本
-  [http://localhost:8081/api/schd/doSettleWrkfee](#)
&gt; 说明：
    1 根据日结结果，计算每日护工工资
    2 每天1点15分 跑该脚本

### 12. 订单逾期脚本
-  [http://localhost:8081/api/schd/ordFinishStt](#)
&gt; 说明：
    1 结算到期订单用户未点击的订单 ，结算成逾期，并且释放床位
    2 每天1点30分 跑该脚本


### 13. 订单结算状态脚本
-  [http://localhost:8081/api/schd/doSttlement](#)
&gt; 说明：
    1 对于用户已经点击结算，护工已经点击结束服务的订单，跑的脚本
    2 分钟跑该脚本</content><author><name>kei gosling</name></author><summary type="html">01. 订单与结算逻辑.结算与支付</summary></entry><entry><title type="html">启东团队制</title><link href="https://thefirstwind.github.io//2020-10-03-%E5%90%AF%E4%B8%9C%E5%9B%A2%E9%98%9F%E5%88%B6/" rel="alternate" type="text/html" title="启东团队制" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E5%90%AF%E4%B8%9C%E5%9B%A2%E9%98%9F%E5%88%B6</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E5%90%AF%E4%B8%9C%E5%9B%A2%E9%98%9F%E5%88%B6/">启东团队制的设计





### 业务数据 病区表 qmgr.qm_hosp_pstn
```
说明：
1 修改条件：POS机代下单的时候，如果有优惠金额， discfg 和 discamount将发生变化
2 当有优惠的时候，影响的字段只有 discfg和 discamount
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| pstnid|Integer|必须| 病区ID |1|
| statncd|Integer|必须| 护工站ID | 31010700052|
| statnnm|String|必须| 护工站名称 | 上海市同济大学附属同济医院(同济医院) |
| building|String|必须| 楼信息 | 观留 |
| floor|String|必须| 层信息 | 1 |
| distrct|String|必须| 病区 | 五官科 |
| &lt;b&gt;usvctp1fg&lt;/b&gt;|String|必须| 一对一订单是否可以在用户端 自主下单 0 不可以 1可以| 1 （启东是0）|
| &lt;b&gt;usvctp2fg&lt;/b&gt;|String|必须| 一对多订单是否可以在用户端 自主下单 0 不可以 1可以| 1 （启东是0）|
| &lt;b&gt;usvctp3fg&lt;/b&gt;|String|必须| 用户端是否可以自主下团队制订单 0 不可以 1可以| 0 （启东是1）|
| &lt;b&gt;grpfg&lt;/b&gt;|String|必须| pos机 团队制标签 0 非团队制 1可以团队制| 0 启东是1）|
| &lt;b&gt;grpprice&lt;/b&gt;|String|必须| 团队制默认价格| 0 启东是500）|



![screencapture-localhost-8888-chosemode-2018-09-12-13_22_44](12.images/screencapture-localhost-8888-chosemode-2018-09-12-13_22_44.png)







![screencapture-localhost-8888-chosemode-2018-09-12-17_01_29](12.images/screencapture-localhost-8888-chosemode-2018-09-12-17_01_29.png)





![screencapture-localhost-8888-chosemode-2018-09-12-17_02_11](12.images/screencapture-localhost-8888-chosemode-2018-09-12-17_02_11.png)</content><author><name>kei gosling</name></author><summary type="html">启东团队制的设计</summary></entry><entry><title type="html">Oa3.0 账户中心</title><link href="https://thefirstwind.github.io//2020-10-03-oa3.0-%E8%B4%A6%E6%88%B7%E4%B8%AD%E5%BF%83/" rel="alternate" type="text/html" title="Oa3.0 账户中心" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//oa3.0-%E8%B4%A6%E6%88%B7%E4%B8%AD%E5%BF%83</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-oa3.0-%E8%B4%A6%E6%88%B7%E4%B8%AD%E5%BF%83/"># OA3.0 账户中心设计

&gt; 
- **时间**：2020年11月2日
- **公司**：上海摩易科技发展有限公司
- **作者**：邢晓宁
- **版权声明**：著作权归上海摩易科技发展有限公司所有，未经允许请勿擅自分享给公司外部人员。


-------------------

[TOC]

## 概要

``` plantuml
@startmindmap

* 账户中心
** 账户金额
*** 总额
*** 可提现额
*** 冻结额
** 账户额度变化快照
*** 角色
**** 用户
**** 护工
**** 护士
**** 商家
**** 平台
*** 类型
**** 收入
***** 变化前额度
***** 变化后额度
***** 快照时间
**** 支出
***** 变化前额度
***** 变化后额度
***** 快照时间
** 明细流水
*** 收入
**** 入账金额
**** 入账时间
**** 关联订单
*** 支出
**** 支出金额
**** 支出时间
** 账单
*** 日账单
*** 月账单
** 动作
*** 提现
*** 充值

@endmindmap
```

## 用户相关的账户操作
```plantuml
@startuml 

== 充值 ==
用户 -&gt; 充值 : 调用充值接口
充值 -&gt; 账户入账 : 申请入账100元
账户入账 -&gt; 账户余额 : 余额+100元
账户余额 -&gt; 用户: 返回余额
== 账户支付 ==
用户 -&gt; 账户余额: 校验余额 &gt;= 100元
账户余额 -&gt; 账户出账: 申请出账100元
账户出账 -&gt; 账户余额: 余额-100元
账户余额 -&gt; 用户: 余额支付成功
== 订单支付(充值 + 账户支付) ==
用户 -&gt; 充值 : 调用支付接口
充值 -&gt; 账户入账 : 申请入账100元
账户入账 -&gt; 账户余额 : 余额+100元
账户余额 -&gt; 账户余额: 校验余额 &gt;= 100元
账户余额 -&gt; 账户出账: 申请出账100元
账户出账 -&gt; 账户余额: 余额-100元
账户余额 -&gt; 用户: 余额支付成功
== 账户退款 ==
用户 -&gt; 账户余额: 用户或系统发起退款申请、校验余额 &gt;= 100元
账户余额 -&gt; 企业支付: 申请企业支付，退款100元给用户
企业支付 -&gt; 账户出账: 支付成功
账户出账 -&gt; 账户余额: -100元
账户余额 -&gt; 用户: 通知用户退款成功
== 提现(同账户退款) ==
用户 -&gt; 账户余额: 用户发起提现申请、校验余额 &gt;= 100元
账户余额 -&gt; 企业支付: 申请企业支付，提现100元给用户
企业支付 -&gt; 账户出账: 支付成功
账户出账 -&gt; 账户余额: -100元
账户余额 -&gt; 用户: 通知用户提现成功
@enduml
```


## 数据字典

### 系统角色

| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 院内订单类型

| 订单类型  | 前提条件 |  工资计算说明| 
| :-------- |:--------| :--: |
| 1对1订单 | 院内有机动护工 | 系统计算、每日按照比例分配 |
| 1对多订单 | 当前病区绑定了护工 |  系统计算、每日按照比例分配   | 
| 团队制订单| 当前病区支持团队制 | 不统计报表  | 
| 单项订单 |擎浩医院管理老师| 待定 | 


## 下单相关流程
### 用户下单(时序图):

``` plantuml
@startuml
用户端 -&gt; POS机: 下单
用户端 -&gt; POS机: [￥支付 微信 ]
用户端 --&gt; 系统: 更新数据
系统 --&gt; POS机: 推送消息
POS机 -&gt; 系统: 评估、补录患者信息
POS机 -&gt; 系统: [￥收款：微信/支付宝/银行卡/现金]
系统 --&gt; 用户端: 查看订单信息
系统 -&gt; PC端: 查看订单信息
系统 -&gt; 护工端: 查看订单信息
系统 -&gt; 系统: 服务开始时间判断
系统 -&gt; 系统: 服务中
护工端 --&gt; 用户端: 推送服务日志
系统 -&gt; 系统: 服务结束时间判断
用户端 --&gt; 护工端: 订单结算
护工端 --&gt; 系统: 服务结算
POS机 --&gt; 用户端: 订单强制结算
POS机 --&gt; 护工端: 订单强制结算
@enduml
```




### POS机代下单(时序图):
``` plantuml
@startuml

POS机 -&gt; 系统 : 填写用户信息、下单
POS机 -&gt; 系统: [￥收款：微信/支付宝/银行卡/现金]
系统 --&gt; 用户手机: 推送短信
PC端 -&gt; 系统: 查看订单信息
护工端 -&gt; 系统: 查看订单信息
系统 -&gt; 系统: 服务开始时间判断
系统-&gt; 系统: 服务中
系统-&gt; 系统: 服务结束时间判断
护工端 --&gt; 系统: 服务结算
POS机 --&gt; 用户手机: 订单强制结算、推送短信
POS机 --&gt; 护工端: 订单强制结算

@enduml
```



## 下单接口文档

### 1. 用户端下单接口说明

- **请求URL**
&gt; [http://localhost:8881/api/order/create](#)

- **请求方式** 
&gt;**POST**

- **请求参数**
  
| 请求参数      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| uopid|String|必须| 用户Uopid|odkVKsyBVCiPkzsiJtmCaaAPs6Xc|
| ordtp|Integer|必须| 订单类型|1|
| svctp|Integer|必须| 服务类型：1 一对一 / 2 一对多 / 3 团队制| 2|
| svcday|Integer|必须| 服务天数| 4| 
| uphone|String|必须| 患者手机号码| 18616579337|
| startday|Date|必须| 服务开始时间| 2018-08-13|
| pstnid|String|必须| 病区ID|581|
| bed|String|必须| 床位号| 33|
| sitmid|Integer|| 价格ID| 297|
| svctp2|String|| 服务类型2||
| nightcare|Boolean|| 夜陪标志|true|
| age|Integer|必须| 年龄| 76|
| disease|Integer||疾病标签||
| rlnm|String||患者真实姓名|患者姓名|
| sex|String|| 性别：0 女 1男| 1|
| wuid|String|| 护工UID| WK_cSjgwj5nIhdzJ_kfd83oNnH6I8yBZ|

- **返回参数**
  
| 返回参数      |     参数类型 |   参数说明   | 参考值|
| :-------- | :--------| :------ |:------ |
| success|   boolean|  请求成功与否||
| code|   Integer|  执行结果code|0|
| message|   String| 执行结果|  执行成功 |
| orduid|   String| 订单号码|  ORD_48dj2B3vU1NkPOQjYpveN6YPOo05 |

- **返回示例**
&gt;    
```java 
{
  &quot;success&quot;: true,
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;操作正确&quot;
  &quot;orduid&quot;:&quot;ORD_48dj2B3vU1NkPOQjYpveN6YPOo05&quot;
}
```
### 2. POS机代下单接口文档
- **请求URL**
&gt; [http://localhost:8883/api/posorder/replace](#)

- **请求方式** 
&gt;**POST**

- **请求参数**

| 请求参数      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| wstatncd|String|必须| 所在护工站CD|31010900053|
| svctp|String|必须| 服务类型：1 一对一 / 2 一对多 / 3 团队制|2|
| svcday|Integer|必须| 服务天数| 8|
| uphone|String|必须| 患者手机| 18616579337| 
| startday|Date|必须| 服务开始时间| 2018-08-13|
| pstnid|String|必须| 病区ID|581|
| bed|String|必须| 床位号| 1|
| age|Integer|必须| 年龄| 76|
| disease|Integer||疾病标签||
| rlnm|String||患者真实姓名|患者姓名|
| sex|String|| 性别：0 女 1男| 1|
| wuid|String|| 护工UID| WK_cSjgwj5nIhdzJ_kfd83oNnH6I8yBZ|
| uoipd|String|| 用户uopid|null|
| sitmid|Integer|| 价格ID| 297|
| grpamount|Integer|| 团队制订单价格| null|

- **返回参数**

| 返回参数      |     参数类型 |   参数说明   | 参考值|
| :-------- | :--------| :------ | :------ | 
| success|   boolean|  请求成功与否| |
| code|   Integer|  执行结果code| |
| message|   String|  执行结果消息| |
| orduid|   String|  执行结果消息|ORD_X7IS7TYobMXybv9hfEqPFoavsrQw |

- **返回示例**
&gt;    
```java 
{
  &quot;success&quot;: true,
  &quot;code&quot;: 200,
  &quot;message&quot;: &quot;操作正确&quot;,
  &quot;orduid&quot;:&quot;ORD_X7IS7TYobMXybv9hfEqPFoavsrQw&quot;
}
```</content><author><name>kei gosling</name></author><summary type="html">OA3.0 账户中心设计</summary></entry><entry><title type="html">订单与结算逻辑 订单变更</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E8%AE%A2%E5%8D%95%E5%8F%98%E6%9B%B4/" rel="alternate" type="text/html" title="订单与结算逻辑 订单变更" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E8%AE%A2%E5%8D%95%E5%8F%98%E6%9B%B4</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E8%AE%A2%E5%8D%95%E5%8F%98%E6%9B%B4/"># 03. 订单与结算逻辑.订单变更

&gt; 
- **时间**：2018年9月7日

@[订单, 结算逻辑, 订单变更]

-------------------

[TOC]

## 订单变更业务范围
&gt; 1 订单类型： 服务中

&gt; 2 适用场景：
 * 更换护工
 * 更换服务项目
 * 更换床位
 * 更换病区
 * 修改服务天数
 * 续单

&gt; 3 注意事项：
 * 由于无法明确 当产生护工变更的情况下 工资如何发放，因此订单变更
 * 不产生支付的情况下，POS机变更 无须POS机管理端审核
 * 当产生支付的情况下，POS机变更 需要管理老师审核，如果6个小时内不审核的话，订单变更将无效

## 数据字典


### 系统角色
| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 订单状态
| 状态  | 状态名称 |  说明|
| :-------- |:--------| :-- |
| 0  | 无状态 | 空状态，冗余字段 |
| 1  | 预约中 | 院外抢单用状态 |
| 2  | 预约成功 | POS机管理老师代接单，并且派工之后的状态 |
| 3  | 待支付（在2小时内付款，超时被取消） | 院内订单下单之后的状态 |
| 4  | 已支付（支付成功） | 支付成功的状态 |
| 5  | 待服务（等待上门服务，计时） | 支付成功之后，2个小时之内保持待服务状态 |
| 6  | 服务中（服务进度） | 支付成功之后，2个小时之后进入服务中状态 |
| 7  | 待结算 | 用户(POS机)发起结算 （等待结算并提示用户结算，超时关闭订单）|
| 8  | 已完成 | 用户(POS机)发起结算之后，如果判断退款成功，状态变为完成 |
| 9  | 待评价 | 冗余状态 |
| 10  | 已评价 | 用户评价完成之后 |
| 11  | 已取消（取消成功） | 超时支付，自动变为取消|
| 12  | 申请退款（发起退款申请） | 待服务状态，申请全额退款的状态 |
| 13  | 退款中（退款已受理，并进行退款程序） | 发起退款的状态 |
| 14  | 退款成功 （退款额转入用户账户） | 用户(POS机)发起退款，如果确认退款成功，状态变为退款成功 |
| 15  | 退款失败（提示失败原因） | 用户(POS机)发起退款，如果确认退款失败，状态变为退款失败 |
| 16  | 变更待服务 | 发起订单变更之后的状态 |
| 17  | 结算中 | 用户(POS机)发起结算，状态变为结算中 |
| 18  | 结算完成 | 用户(POS机)发起结算，如果确认结算成功，状态变为结算完成 |
| 19  | 结算失败 | 用户(POS机)发起结算，如果确认结算失败，状态变为结算失败 |



## 数据库设计
### 订单变更表
```
说明：
1 插入条件：服务中的订单，发生变化的情况
2 修改条件：POS机管理端管理老师审核之后aplfg会变化、过期不审核aplfg也会变化
3 终止条件：审核通过
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| id|Integer|必须| 订单变更ID|1|
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| neworduid|String|必须| 新订单号&lt;br/&gt;当有支付时，生成新订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| orgfg|Integer|必须| 原订单标志 1原始订单记录 2修改后的订单记录| 1|
| chgwrkfg|Integer|| 是否更换护工 0 不换人 1 换人| 1|
| wuid|String|必须| 护工UID| WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| svctp|String|必须| 交易号| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| unitprice|Integer|必须|  服务项目单价| 9000|
| amount|Integer|必须| 服务项目小计 服务项目单价 X 服务天数（精算）| 90000|
| statncd|String|必须|服务网点 订单服务网点（非网点，没有代码） |31010700052 |
| statnnm|String|必须| 服务医院 医院名称| 上海市同济大学附属同济医院(同济医院)|
| sitmid|Integer|必须| 服务价格ID| 835|
| needpayfg|Integer|必须| 是否需要支付| 1|
| ordlessfee|Integer|必须| 订单剩余价格| 90000|
| continufee|Integer|必须| 结转金额| 10000|
| payfee|Integer|必须| 支付金额| 80000|
| aplfg|Integer|必须| 申请状态 0 申请中 1 批准 2 驳回（过期）| 1|


### 订单主表
```
说明：
1 插入条件：用户下单、POS机下单、发生支付的订单变更
2 修改条件：支付、超时未支付、补录患者信息、订单变更、订单结算（用户或者POS发起的结算）、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| ordid|String|必须| 订单ID|1804050053004W|
| uopid|String|必须| 患者openid| ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| tradeno|String|必须| 支付UID| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| ptorduid|String|必须| 患者姓名| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| rlnm|String|必须| 父订单号，续单用，初始值为其本身如果有续单或者纠纷负单则为其父单orduid| 王根娣|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| statncd|String|必须| 护工站代码| 31010700052|
| statnnm|String|必须| 护工站| 上海市同济大学附属同济医院(同济医院)|
| amount|Integer|必须| 订单初始预收金额| 90000|
| ordlessfee|Integer|| 订单剩余金额| 0|
| status1|Integer|| 0 无状态  &lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功 &lt;br/&gt;3 待支付（在2小时内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成 &lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt; 11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因） &lt;br/&gt;16 变更待服务 &lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 &lt;br/&gt;| 5|
| status1nm|String|| 同上| 待服务|
| usrconftm|datetime||用户确认完成时间| 2018-04-14 14:54:50|
| splitsttlfg|Integer|| 拆分结算标识0：未拆分结算，1已拆分结算| 0|
| continufee|Integer|| 结转金额| 0|
| chgstatus|Integer||  1 变更未开始 &lt;br/&gt;2 变更已开始&lt;br/&gt;| 0|
| sttlefg|Integer|| 结算标识：给用户退款订单结算掉，成功结算更新 0默认,1已结算| 0|



### 订单详情表
```
说明：
1 插入条件：用户下单、POS机下单、不发生支付的订单变更
2 修改条件：订单变更、订单结算（用户或POS发起的订单结算）、护工结束服务、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| wuid|String|必须| 护工Uid| WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| wstatncd|String|必须| 所属网点 该护工所属网点|31010700052 |
| statncd|String|必须|服务网点 订单服务网点（非网点，没有代码） |31010700052 |
| hospnm|String|必须| 服务医院 医院名称| 上海市同济大学附属同济医院(同济医院)|
| sitmid|Integer|必须| 服务项目 当ordtp属于院内时| |
| svctp|String|必须| 交易号| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| unitprice|Integer|必须|  服务项目单价| 9000|
| amount|Integer|必须| 服务项目小计 服务项目单价 X 服务天数（精算）| 90000|
| adjustday|decimal(4,2)|| 调整天数 -0.5 0  0.5 三个值，在最后一天结算| 0|
| status1|Integer|| 0 无状态&lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功&lt;br/&gt;3 待支付（在15分钟内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）.&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成&lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt;11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因）&lt;br/&gt;16 变更待服务&lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 | 5|
| status1nm|String||同上 | 待服务|
| status3|Integer|| 状态-完成 0 无状态 1 完成 | 1|
| status3nm|String|| 状态-完成-说明 保存护工的做工状态 | 完成|
| factsvcfg|Integer|| 子单实际服务标识：0 是默认，1 是结算退款记录， 2 是退款记录{tips:该子单是否是实际服务单} | 0|



### 支付信息表
```
说明：
1 插入条件：支付、退款、结算等，有金额流转的情况
2 修改条件：支付成功后状态 paid状态更新，结算申请发起、结算状态更新、退款状态发起、退款状态更新。
3 终止条件：超时未支付、支付完成、结算完成、退款完成、
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| tradeno|String|必须| 支付订单号 tr+&quot;-&quot;+36位UUID（带-）&lt;br/&gt;微信线上支付 pt开头&lt;br/&gt;微信扫码支付 td开头&lt;br/&gt;银联支付 tr开头|TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| uopid|String|| 用户UID 支付者UID，不一定是被服务的患者|ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| fopid|String|| 推荐者UID 推荐者UID||
| ttype|Integer|| 订单类型 1医院 2医院单项 3居家|1|
| paid|Integer|| 是否已支付 &lt;br/&gt;0 未支付 &lt;br/&gt;1 线上支付 &lt;br/&gt;2 现金支付&lt;br/&gt;3 退款成功&lt;br/&gt;4 退款失败|1|
| paidtm|datetime|| 支付时间 非0的时候 才有值|2018-04-05 10:58:56|
| payment|Integer|| 支付方式 &lt;br/&gt;1 微信 &lt;br/&gt;2 刷卡（借记卡） &lt;br/&gt;3 刷卡（信用卡） &lt;br/&gt;4 现金（线下支付）&lt;br/&gt; 5 支付宝|1|
| amount|Integer|| 支付金额|90000|
| outorderno|String|| 外部订单号 外部订单号||
| outtransno|String|| 外部流水号 外部流水号|4200000095201804052560224795|
| resttlfg|Integer|| 预结算标志位：0未结算，1已结算||
| sttlfg|Integer|| 已结算标志 0未结算 1 已结算||
| sttlamt|Integer|| 结算金额||
| invoicetm|datetime|| 预分账标志位||
| reinvfg|Integer|| 分账标志||
| invoicefg|Integer|| ||
| refund|Integer|| 退款标志 现阶段价格统一。&lt;br/&gt;该字段为空，当每个省价格不同时，会用到。&lt;br/&gt;0是付款 1是退款|0|
| cardNo|String|| 银联支付用字段: 支付时所用的卡号(该字段当银联支付退款时使用)||
| transChnName|String|| 支付渠道名称||
| transEngName|String|| 支付渠道||
| refNo|String|| 银联支付用参考号||
| merchantNo|String|| 根据支付时的，商户编号||
| terminalNo|String|| pos机终端号码||
| traceNo|String|| 银联商务支付的记录号(每一个pos机从1开始计数)||





## 订单变更的流程
### 用户端发起订单变更(无需支付):
```sequence
用户端-&gt;[数据库]: 1 患者发起订单变更
用户端-&gt;[数据库]: 2 变更订单（无支付）
POS机-&gt;[数据库]: 确认变更申请
POS机-&gt;[数据库]: 变更审核
[批处理]-&gt;[批处理]: 是否超过6小时没有审核
[批处理]-&gt;[数据库]: 超过6小时没有审核，变更自动作废
[批处理]-&gt;[数据库]: 退款
[批处理]-&gt;[批处理]: 新开始服务时间 &lt; 当前时间
[批处理]-&gt;[数据库]: 旧订单(服务中)、新订单(变更待服务)
[批处理]-&gt;[批处理]: 新开始服务时间 &gt;= 当前时间
[批处理]-&gt;[数据库]: 旧订单(已完成)、新订单(服务中)
[批处理]--&gt;用户端: 通知用户服务已开始
[批处理]--&gt;护工端: 通知旧护工服务已结束
[批处理]--&gt;护工端: 通知新护工服务已开始
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结束
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```

### 用户端发起订单变更(需支付):
```sequence
用户端-&gt;[数据库]: 1 患者发起订单变更
用户端-&gt;[数据库]: 2 变更订单（需要支付）
用户端--&gt;[数据库]: 3 支付
POS机-&gt;[数据库]: 确认变更申请
POS机--&gt;[数据库]: 支付
POS机-&gt;[数据库]: 变更审核
[批处理]-&gt;[批处理]: 是否超过6小时没有审核
[批处理]-&gt;[数据库]: 超过6小时没有审核，变更自动作废
[批处理]-&gt;[数据库]: 退款
[批处理]-&gt;[批处理]: 新开始服务时间 &lt; 当前时间
[批处理]-&gt;[数据库]: 旧订单(服务中)、新订单(变更待服务)
[批处理]-&gt;[批处理]: 新开始服务时间 &gt;= 当前时间
[批处理]-&gt;[数据库]: 旧订单(已完成)、新订单(服务中)
[批处理]--&gt;用户端: 通知用户服务已开始
[批处理]--&gt;护工端: 通知旧护工服务已结束
[批处理]--&gt;护工端: 通知新护工服务已开始
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结束
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```

### POS机发起订单变更(无需支付):
```sequence
POS机-&gt;[数据库]: POS机发起订单变更
POS机-&gt;[数据库]: 变更订单（无支付）
POS机-&gt;[数据库]: 确认变更申请
POS机-&gt;[数据库]: 变更直接生效
[批处理]-&gt;[批处理]: 新开始服务时间 &lt; 当前时间
[批处理]-&gt;[数据库]: 旧订单(服务中)、新订单(变更待服务)
[批处理]-&gt;[批处理]: 新开始服务时间 &gt;= 当前时间
[批处理]-&gt;[数据库]: 旧订单(已完成)、新订单(服务中)
[批处理]--&gt;用户端: 通知用户服务已开始
[批处理]--&gt;护工端: 通知旧护工服务已结束
[批处理]--&gt;护工端: 通知新护工服务已开始
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结束
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```

### 用户端发起订单变更(需支付):
```sequence
POS机-&gt;[数据库]: 患者发起订单变更
POS机-&gt;[数据库]: 变更订单（需要支付）
POS机--&gt;[数据库]: 支付
POS机-&gt;[数据库]: 确认变更申请
POS机-&gt;[数据库]: 变更审核
[批处理]-&gt;[批处理]: 是否超过6小时没有审核
[批处理]-&gt;[数据库]: 超过6小时没有审核，变更自动作废
[批处理]-&gt;[数据库]: 退款
[批处理]-&gt;[批处理]: 新开始服务时间 &lt; 当前时间
[批处理]-&gt;[数据库]: 旧订单(服务中)、新订单(变更待服务)
[批处理]-&gt;[批处理]: 新开始服务时间 &gt;= 当前时间
[批处理]-&gt;[数据库]: 旧订单(已完成)、新订单(服务中)
[批处理]--&gt;用户端: 通知用户服务已开始
[批处理]--&gt;护工端: 通知旧护工服务已结束
[批处理]--&gt;护工端: 通知新护工服务已开始
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结束
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```

## 后台批处理接口说明

### 01. 审核超时的退款处理
-  [http://localhost:8081/api/schd/cancelUnaplyToUnPayOrd](#)
&gt; 说明：
    1 清理6小时内审核未通过的订单
	2 如果有的话，直接退款

### 02. 修改变更服务变成待服务(立即执行) 没有支付的订单变更
只有审批通过的变更待服务才能进入服务状态，否者6个小时后回恢复、并且退款
-  [http://localhost:8081/api/schd/orderChangeSerStart](#)
&gt; 说明：
    1 到了变更后的开始时间，
	2 老订单完结，新订单进入开始服务状态


### 03. 变更订单的等待状态变成开始服务 有支付状态的订单变更
-  [http://localhost:8081/api/schd/orderChangeWaitSerToSer](#)
&gt; 说明：
    1 到了变更后的开始时间，
	2 老订单完结，新订单进入开始服务状态</content><author><name>kei gosling</name></author><summary type="html">03. 订单与结算逻辑.订单变更</summary></entry><entry><title type="html">订单与结算逻辑 订单</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E8%AE%A2%E5%8D%95/" rel="alternate" type="text/html" title="订单与结算逻辑 订单" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E8%AE%A2%E5%8D%95</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E8%AE%A2%E5%8D%95/"># 01. 订单与结算逻辑.订单

&gt; 
- **时间**：2018年8月9日
@[订单, 支付方式, 结算逻辑]

-------------------

[TOC]

## 数据字典

### 系统角色
| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 院内订单类型
| 订单类型  | 前提条件 |  工资计算说明| 
| :-------- |:--------| :--: |
| 1对1订单 | 院内有机动护工 | 系统计算、每日按照比例分配 |
| 1对多订单 | 当前病区绑定了护工 |  系统计算、每日按照比例分配   | 
| 团队制订单| 当前病区支持团队制 | 不统计报表  | 
| 单项订单 |擎浩医院管理老师| 待定 | 


## 下单相关流程
### 用户下单(时序图):

``` plantuml
@startuml
用户端 -&gt; POS机: 下单
用户端 -&gt; POS机: [￥支付 微信 ]
用户端 --&gt; 系统: 更新数据
系统 --&gt; POS机: 推送消息
POS机 -&gt; 系统: 评估、补录患者信息
POS机 -&gt; 系统: [￥收款：微信/支付宝/银行卡/现金]
系统 --&gt; 用户端: 查看订单信息
系统 -&gt; PC端: 查看订单信息
系统 -&gt; 护工端: 查看订单信息
系统 -&gt; 系统: 服务开始时间判断
系统 -&gt; 系统: 服务中
护工端 --&gt; 用户端: 推送服务日志
系统 -&gt; 系统: 服务结束时间判断
用户端 --&gt; 护工端: 订单结算
护工端 --&gt; 系统: 服务结算
POS机 --&gt; 用户端: 订单强制结算
POS机 --&gt; 护工端: 订单强制结算
@enduml
```


###用户下单(流程图):
``` flow
st=&gt;start: 开始
e=&gt;end: 结束
e2=&gt;end: 结束
op1=&gt;operation: 填写患者信息
sub1=&gt;subroutine: 选择1对1护工
sub2=&gt;subroutine: 选择1对多护工
cond1=&gt;condition: 选择下单方式（1对1）
cond2=&gt;condition: 选择下单方式（1对多）
sub3=&gt;subroutine: 微信、支付宝、银行卡、现金
cond3=&gt;condition: 在线微信支付
op4=&gt;operation: POS机收款
op5=&gt;operation: POS机收款成功
op6=&gt;operation: 支付成功


st-&gt;op1-&gt;cond1
cond1(no)-&gt;cond2
cond1(yes)-&gt;sub1-&gt;cond3
cond2(yes)-&gt;sub2-&gt;cond3
cond2(no)-&gt;e2
cond3(no,left)-&gt;op4-&gt;sub3-&gt;op5-&gt;e
cond3(yes)-&gt;op6-&gt;e2

```


### POS机代下单(时序图):
```plantuml
@startuml
POS机 -&gt; 系统 : 填写用户信息、下单
POS机 -&gt; 系统: [￥收款：微信/支付宝/银行卡/现金]
系统 --&gt; 用户手机: 推送短信
PC端 -&gt; 系统: 查看订单信息
护工端 -&gt; 系统: 查看订单信息
系统 -&gt; 系统: 服务开始时间判断
系统-&gt; 系统: 服务中
系统-&gt; 系统: 服务结束时间判断
护工端 --&gt; 系统: 服务结算
POS机 --&gt; 用户手机: 订单强制结算、推送短信
POS机 --&gt; 护工端: 订单强制结算
@enduml
```


### POS机代下单(流程图):
``` flow
st=&gt;start: 开始
e=&gt;end: 结束
e2=&gt;end: 结束
op1=&gt;operation: 填写患者信息
sub1=&gt;subroutine: 选择1对1护工
sub2=&gt;subroutine: 选择1对多护工
cond1=&gt;condition: 选择下单方式（1对1）
cond2=&gt;condition: 选择下单方式（1对多）
sub3=&gt;subroutine: 微信、支付宝、银行卡、现金
cond3=&gt;condition: 在线微信支付
op4=&gt;operation: POS机收款
op5=&gt;operation: POS机收款成功
op6=&gt;operation: 支付成功


st-&gt;op1-&gt;cond1
cond1(no)-&gt;cond2
cond1(yes)-&gt;sub1-&gt;cond3
cond2(yes)-&gt;sub2-&gt;cond3
cond2(no)-&gt;e2
cond3(no,left)-&gt;op4-&gt;sub3-&gt;op5-&gt;e
cond3(yes)-&gt;op6-&gt;e2

```


## 下单接口文档

### 1. 用户端下单接口说明

- **请求URL**
&gt; [http://localhost:8881/api/order/create](#)

- **请求方式** 
&gt;**POST**

- **请求参数**
  
| 请求参数      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| uopid|String|必须| 用户Uopid|odkVKsyBVCiPkzsiJtmCaaAPs6Xc|
| ordtp|Integer|必须| 订单类型|1|
| svctp|Integer|必须| 服务类型：1 一对一 / 2 一对多 / 3 团队制| 2|
| svcday|Integer|必须| 服务天数| 4| 
| uphone|String|必须| 患者手机号码| 18616579337|
| startday|Date|必须| 服务开始时间| 2018-08-13|
| pstnid|String|必须| 病区ID|581|
| bed|String|必须| 床位号| 33|
| sitmid|Integer|| 价格ID| 297|
| svctp2|String|| 服务类型2||
| nightcare|Boolean|| 夜陪标志|true|
| age|Integer|必须| 年龄| 76|
| disease|Integer||疾病标签||
| rlnm|String||患者真实姓名|患者姓名|
| sex|String|| 性别：0 女 1男| 1|
| wuid|String|| 护工UID| WK_cSjgwj5nIhdzJ_kfd83oNnH6I8yBZ|

- **返回参数**
  
| 返回参数      |     参数类型 |   参数说明   | 参考值|
| :-------- | :--------| :------ |:------ |
| success|   boolean|  请求成功与否||
| code|   Integer|  执行结果code|0|
| message|   String| 执行结果|  执行成功 |
| orduid|   String| 订单号码|  ORD_48dj2B3vU1NkPOQjYpveN6YPOo05 |

- **返回示例**
&gt;    
```java 
{
  &quot;success&quot;: true,
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;操作正确&quot;
  &quot;orduid&quot;:&quot;ORD_48dj2B3vU1NkPOQjYpveN6YPOo05&quot;
}
```
### 2. POS机代下单接口文档
- **请求URL**
&gt; [http://localhost:8883/api/posorder/replace](#)

- **请求方式** 
&gt;**POST**

- **请求参数**

| 请求参数      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| wstatncd|String|必须| 所在护工站CD|31010900053|
| svctp|String|必须| 服务类型：1 一对一 / 2 一对多 / 3 团队制|2|
| svcday|Integer|必须| 服务天数| 8|
| uphone|String|必须| 患者手机| 18616579337| 
| startday|Date|必须| 服务开始时间| 2018-08-13|
| pstnid|String|必须| 病区ID|581|
| bed|String|必须| 床位号| 1|
| age|Integer|必须| 年龄| 76|
| disease|Integer||疾病标签||
| rlnm|String||患者真实姓名|患者姓名|
| sex|String|| 性别：0 女 1男| 1|
| wuid|String|| 护工UID| WK_cSjgwj5nIhdzJ_kfd83oNnH6I8yBZ|
| uoipd|String|| 用户uopid|null|
| sitmid|Integer|| 价格ID| 297|
| grpamount|Integer|| 团队制订单价格| null|

- **返回参数**

| 返回参数      |     参数类型 |   参数说明   | 参考值|
| :-------- | :--------| :------ | :------ | 
| success|   boolean|  请求成功与否| |
| code|   Integer|  执行结果code| |
| message|   String|  执行结果消息| |
| orduid|   String|  执行结果消息|ORD_X7IS7TYobMXybv9hfEqPFoavsrQw |

- **返回示例**
&gt;    
```java 
{
  &quot;success&quot;: true,
  &quot;code&quot;: 200,
  &quot;message&quot;: &quot;操作正确&quot;,
  &quot;orduid&quot;:&quot;ORD_X7IS7TYobMXybv9hfEqPFoavsrQw&quot;
}
```</content><author><name>kei gosling</name></author><summary type="html">01. 订单与结算逻辑.订单</summary></entry><entry><title type="html">订单与结算逻辑 结算与支付</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E7%BB%93%E7%AE%97%E4%B8%8E%E6%94%AF%E4%BB%98/" rel="alternate" type="text/html" title="订单与结算逻辑 结算与支付" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E7%BB%93%E7%AE%97%E4%B8%8E%E6%94%AF%E4%BB%98</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E4%B8%8E%E7%BB%93%E7%AE%97%E9%80%BB%E8%BE%91-%E7%BB%93%E7%AE%97%E4%B8%8E%E6%94%AF%E4%BB%98/"># 01. 订单与结算逻辑.结算与支付

&gt; 
- **时间**：2018年8月23日

@[订单, 结算逻辑]

-------------------

[TOC]

## 数据字典


### 系统角色
| 端  |    用户群体 |    终端类型 | 终端名称  |
| :-------- |:--------| :--: |:--------|
| 用户端  |患者、消费者 | 微信公众号 | E护通  |
| 护工端  |院内护工、居家护工 |  微信公众号  | E护通\|护工  |
| 护士端  |提供上门服务的在册护士 | 微信公众号/APP  | 护通\|专护 |
| POS机端 |擎浩医院管理老师| POS机  |  |
| PC端 |财务、运营、系统管理员等| PC电脑端 |   |
| 统计端|院方高层、护理界高层| 微信公众号  | 擎浩护理  |


### 院内订单类型
| 订单类型  | 前提条件 |  工资计算说明|
| :-------- |:--------| :--: |
| 1对1订单 | 院内有机动护工 | 系统计算、每日按照比例分配 |
| 1对多订单 | 当前病区绑定了护工 |  系统计算、每日按照比例分配   |
| 团队制订单| 当前病区支持团队制 | 不统计报表  |
| 单项订单 |擎浩医院管理老师| 待定 |

### 订单状态
| 状态  | 状态名称 |  说明|
| :-------- |:--------| :-- |
| 0  | 无状态 | 空状态，冗余字段 |
| 1  | 预约中 | 院外抢单用状态 |
| 2  | 预约成功 | POS机管理老师代接单，并且派工之后的状态 |
| 3  | 待支付（在2小时内付款，超时被取消） | 院内订单下单之后的状态 |
| 4  | 已支付（支付成功） | 支付成功的状态 |
| 5  | 待服务（等待上门服务，计时） | 支付成功之后，2个小时之内保持待服务状态 |
| 6  | 服务中（服务进度） | 支付成功之后，2个小时之后进入服务中状态 |
| 7  | 待结算 | 用户(POS机)发起结算 （等待结算并提示用户结算，超时关闭订单）|
| 8  | 已完成 | 用户(POS机)发起结算之后，如果判断退款成功，状态变为完成 |
| 9  | 待评价 | 冗余状态 |
| 10  | 已评价 | 用户评价完成之后 |
| 11  | 已取消（取消成功） | 超时支付，自动变为取消|
| 12  | 申请退款（发起退款申请） | 待服务状态，申请全额退款的状态 |
| 13  | 退款中（退款已受理，并进行退款程序） | 发起退款的状态 |
| 14  | 退款成功 （退款额转入用户账户） | 用户(POS机)发起退款，如果确认退款成功，状态变为退款成功 |
| 15  | 退款失败（提示失败原因） | 用户(POS机)发起退款，如果确认退款失败，状态变为退款失败 |
| 16  | 变更待服务 | 发起订单变更之后的状态 |
| 17  | 结算中 | 用户(POS机)发起结算，状态变为结算中 |
| 18  | 结算完成 | 用户(POS机)发起结算，如果确认结算成功，状态变为结算完成 |
| 19  | 结算失败 | 用户(POS机)发起结算，如果确认结算失败，状态变为结算失败 |



## 数据库设计

### 订单主表
```
说明：
1 插入条件：用户下单、POS机下单、发生支付的订单变更
2 修改条件：支付、超时未支付、补录患者信息、订单变更、订单结算（用户或者POS发起的结算）、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| ordid|String|必须| 订单ID|1804050053004W|
| uopid|String|必须| 患者openid| ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| tradeno|String|必须| 支付UID| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| ptorduid|String|必须| 患者姓名| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| rlnm|String|必须| 父订单号，续单用，初始值为其本身如果有续单或者纠纷负单则为其父单orduid| 王根娣|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| statncd|String|必须| 护工站代码| 31010700052|
| statnnm|String|必须| 护工站| 上海市同济大学附属同济医院(同济医院)|
| amount|Integer|必须| 订单初始预收金额| 90000|
| ordlessfee|Integer|| 订单剩余金额| 0|
| status1|Integer|| 0 无状态  &lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功 &lt;br/&gt;3 待支付（在2小时内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成 &lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt; 11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因） &lt;br/&gt;16 变更待服务 &lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 &lt;br/&gt;| 5|
| status1nm|String|| 同上| 待服务|
| usrconftm|datetime||用户确认完成时间| 2018-04-14 14:54:50|
| splitsttlfg|Integer|| 拆分结算标识0：未拆分结算，1已拆分结算| 0|
| continufee|Integer|| 结转金额| 0|
| chgstatus|Integer||  1 变更未开始 &lt;br/&gt;2 变更已开始&lt;br/&gt;| 0|
| sttlefg|Integer|| 结算标识：给用户退款订单结算掉，成功结算更新 0默认,1已结算| 0|



### 订单详情表
```
说明：
1 插入条件：用户下单、POS机下单、不发生支付的订单变更
2 修改条件：订单变更、订单结算（用户或POS发起的订单结算）、护工结束服务、其他影响状态变化的节点
3 终止条件：超时未支付、订单完成
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| wuid|String|必须| 护工Uid| WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| wstatncd|String|必须| 所属网点 该护工所属网点|31010700052 |
| statncd|String|必须|服务网点 订单服务网点（非网点，没有代码） |31010700052 |
| hospnm|String|必须| 服务医院 医院名称| 上海市同济大学附属同济医院(同济医院)|
| sitmid|Integer|必须| 服务项目 当ordtp属于院内时| |
| svctp|String|必须| 交易号| TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| startday|date|必须| 服务开始时间 默认当前日期| 2018-04-05|
| svcday|Integer|必须| 服务天数| 10|
| unitprice|Integer|必须|  服务项目单价| 9000|
| amount|Integer|必须| 服务项目小计 服务项目单价 X 服务天数（精算）| 90000|
| adjustday|decimal(4,2)|| 调整天数 -0.5 0  0.5 三个值，在最后一天结算| 0|
| status1|Integer|| 0 无状态&lt;br/&gt;1 预约中 &lt;br/&gt;2 预约成功&lt;br/&gt;3 待支付（在15分钟内付款，超时被取消） &lt;br/&gt;4 已支付（支付成功）.&lt;br/&gt;5 待服务（等待上门服务，计时）&lt;br/&gt;6 服务中（服务进度）&lt;br/&gt;7 待结算（等待结算并提示用户结算，超时关闭订单）&lt;br/&gt;8 已完成&lt;br/&gt;9 待评价 &lt;br/&gt;10 已评价&lt;br/&gt;11 已取消（取消成功） &lt;br/&gt;12 申请退款（发起退款申请） &lt;br/&gt;13 退款中（退款已受理，并进行退款程序） &lt;br/&gt;14 退款成功 （退款额转入用户账户） &lt;br/&gt;15 退款失败（提示失败原因）&lt;br/&gt;16 变更待服务&lt;br/&gt;17 结算中 &lt;br/&gt;18 结算完成 &lt;br/&gt;19结算失败 | 5|
| status1nm|String||同上 | 待服务|
| status3|Integer|| 状态-完成 0 无状态 1 完成 | 1|
| status3nm|String|| 状态-完成-说明 保存护工的做工状态 | 完成|
| factsvcfg|Integer|| 子单实际服务标识：0 是默认，1 是结算退款记录， 2 是退款记录{tips:该子单是否是实际服务单} | 0|



### 支付信息表
```
说明：
1 插入条件：支付、退款、结算等，有金额流转的情况
2 修改条件：支付成功后状态 paid状态更新，结算申请发起、结算状态更新、退款状态发起、退款状态更新。
3 终止条件：超时未支付、支付完成、结算完成、退款完成、
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| tradeno|String|必须| 支付订单号 tr+&quot;-&quot;+36位UUID（带-）&lt;br/&gt;微信线上支付 pt开头&lt;br/&gt;微信扫码支付 td开头&lt;br/&gt;银联支付 tr开头|TDU_Kn2yCIWlcOYD7V4KmcWfW76Ngynl|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| uopid|String|| 用户UID 支付者UID，不一定是被服务的患者|ooDqLwHXcSIFoMZxTX3DtHkLtaOM|
| fopid|String|| 推荐者UID 推荐者UID||
| ttype|Integer|| 订单类型 1医院 2医院单项 3居家|1|
| paid|Integer|| 是否已支付 &lt;br/&gt;0 未支付 &lt;br/&gt;1 线上支付 &lt;br/&gt;2 现金支付&lt;br/&gt;3 退款成功&lt;br/&gt;4 退款失败|1|
| paidtm|datetime|| 支付时间 非0的时候 才有值|2018-04-05 10:58:56|
| payment|Integer|| 支付方式 &lt;br/&gt;1 微信 &lt;br/&gt;2 刷卡（借记卡） &lt;br/&gt;3 刷卡（信用卡） &lt;br/&gt;4 现金（线下支付）&lt;br/&gt; 5 支付宝|1|
| amount|Integer|| 支付金额|90000|
| outorderno|String|| 外部订单号 外部订单号||
| outtransno|String|| 外部流水号 外部流水号|4200000095201804052560224795|
| resttlfg|Integer|| 预结算标志位：0未结算，1已结算||
| sttlfg|Integer|| 已结算标志 0未结算 1 已结算||
| sttlamt|Integer|| 结算金额||
| invoicetm|datetime|| 预分账标志位||
| reinvfg|Integer|| 分账标志||
| invoicefg|Integer|| ||
| refund|Integer|| 退款标志 现阶段价格统一。&lt;br/&gt;该字段为空，当每个省价格不同时，会用到。&lt;br/&gt;0是付款 1是退款|0|
| cardNo|String|| 银联支付用字段: 支付时所用的卡号(该字段当银联支付退款时使用)||
| transChnName|String|| 支付渠道名称||
| transEngName|String|| 支付渠道||
| refNo|String|| 银联支付用参考号||
| merchantNo|String|| 根据支付时的，商户编号||
| terminalNo|String|| pos机终端号码||
| traceNo|String|| 银联商务支付的记录号(每一个pos机从1开始计数)||



### 日结表
```
说明：
1 插入条件：开始服务的订单，每日12:30/23:30 进行结算
2 修改条件：无
3 终止条件：预付款消耗完为止
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| daysttuid|String|必须| 日结算UID|DST_VwACGXWSvbwTfEm9I_6dPyvWKkw2|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| porduid|String|必须| 母单orduid| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| sttdate|date|必须| 结算日期| 2018-04-05|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| daysttfee|Integer|| 日结算金额|9000|
| lessordfee|Integer|| 订单剩余金额(结余金额)|81000|
| daystttm|datetime|| 结算时间|2018-04-09 23:30:00|
| unitprice|Integer|| 单价 | 9000 |
| statncd|String|| 做单护工站 | 31010700052 |
| plusfee|String|| 增收 | 450 |
| wrkfee|String|| 护工工资 | 5400 |
| hospfee|String|| 医院管理费 | 900 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 2033 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 100 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| refundfee|String|| 退款金额 | 0 |



### 结算表
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| subid|Integer|必须| 订单Subid, 子单号|1|
| statncd|String|必须| 需求方所在护工站，如果院外非网点或居家为空|31010700052|
| wstatncd|String|必须| 护工所在护工站|31010700052|
| wuid|String|必须| 护工wuid|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| sttamount|Integer|必须| 结算金额(合算=医院管理费+护工工资+毛利润)|90000|
| unitprice|Integer|必须| 单价 护工身价*系数（目前100%）+保险 | 9000 |
| svcday|Integer|必须| 服务天数 | 10 |
| plusfee|String|| 增收 | 4500 |
| wrkfee|String|| 护工工资 | 54000 |
| hospfee|String|| 医院管理费 | 9000 |
| companyfee|String|| 管理费（公司管理费:statncd=wstatncd的时候该字段和服务项目单价拆分的公司管理费一致，如果statncd&lt;&gt;wstatncd三七开的订单，则此字段记录总利润 即=sttamount - wrkfee - recomfee） | 21383 |
| platamount|String|| 平台费用 | 0 |
| deptfee|String|| 科室费 | 1000 |
| insuranfee|String|| 保险费 | 0 |
| recomfee|String|| 推荐有奖金额 | 0 |
| platformfee|String|| 护工点击结束后用户遗留平台金额 | 0 |
| payfee|String|| 支付金额 | 90000 |
| usrnewordfee|String|| 用户续单结转 | 0 |
| invoicefg|Integer|| 分账标识0未分账，1已分账 针对是否分账到qo_ord_fin_statn_invoice表而标识 | 1 |
| isdowrkfeefg|String|| 护工工资标识 | 1 |

### 护工站分账明细
```
说明：
1 插入条件：结算完成
2 修改条件：无
3 终止条件：结算完成
```

| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| finuid|String|必须| 利益分账UID|FI_5NN3QewfIAJPKvTANe2xwG8nPFmUM|
| sttuid|String|必须| 日结算UID|ST_o9wTyvpiSuSqmbjsMonkilWvm7qXz|
| orduid|String|必须| 订单UID 订单主表ID| ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| requirstatncd|String|必须| 发单方statncd|31010700052|
| requirfee|Integer|必须| 发单方收益|0|
| wrkstatncd|String|必须| 派单方statncd|31010700052|
| wrkstatnfee|Integer|必须| 派单方收益|0|
| wrkfee|Integer|| 护工工资 | 54000 |
| hospfee|Integer|| 医院管理费 | 9000 |
| recomfee|Integer|| 推荐有奖金额 | 0 |
| insurfee|Integer|| 保险费 | 0 |
| plusfee|Integer|| 增收 | 0 |
| suplid|Integer|| 加盟商cd | 1 |
| suplfee|Integer|| 发单方加盟商收益 | 21383 |
| platfeee|Integer|| 平台遗留金额 | 0 |
| platamount|Integer|| 平台费用 | 0 |

### 护工工资表
```
说明：
1 插入条件：护工点击完成服务，+15天之后分账
2 修改条件：无
3 终止条件：护工点击完成服务，+15天之后分账
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| wiuid|String|必须| 收入UIDWI开头32位UUID|WI_DxhX4TG2DPkqMyCLLETeUoa4nbtJ0|
| wuid|String|必须| 护工编号UIDWK开头32位UUID|WK_bRyaLdFbHDI9VjxUhSar1BLFEHOSh|
| witp|Integer|必须| 收入类型收入类型 1 订单 2 推荐分享 3 奖励 4 积分换取 |1|
| income|Integer|必须| 收入单位是分 |54000|
| status|Integer|必须| 状态&lt;br/&gt;0 订单服务中 &lt;br/&gt;1 等待结算  &lt;br/&gt;2 系统审核中 &lt;br/&gt;9已生效&lt;br/&gt; (订单服务中状态为0，&lt;br/&gt;订单服务截止之间到但未被结算状态为1,&lt;br/&gt;订单被投诉 状态为2，&lt;br/&gt;订单结束并结算再加14天 状态为9，) |2|
| cashed|Integer|必须| 是否已提现0 未体现 1 已提现 |1|
| cashtm|DateTime|必须| 提现时间提现的时间 |2018-04-09 23:30:00|



## 订单状态变化与结算数据的流程
### 订单状态变化(时序图):
```plantuml
用户端-&gt;[数据库]: 1 用户自主下单(院外订单)
用户端-&gt;[数据库]: 2 用户自主下单(院内订单)
POS机-&gt;[数据库]: POS机管理老师接单、并且派工
[批处理]-&gt;[数据库]: 2小时无人反映，取消订单
用户端-&gt;[数据库]: [￥支付 微信 ]
POS机-&gt;[数据库]: [￥收款：微信/支付宝/银行卡/现金]
[批处理]-&gt;[批处理]: 30分钟内不支付，支付状态超时
[批处理]--&gt;[数据库]: 取消订单
[批处理]-&gt;[批处理]: 支付成功之后，2小时内处于待服务状态，超过2小时进入服务中
[批处理]--&gt;[数据库]: 待服务-&gt;服务中
[数据库]--&gt;用户端: 查看订单信息
[数据库]-&gt;PC端: 查看订单信息
[数据库]-&gt;护工端: 查看订单信息
护工端--&gt;用户端: 推送服务日志
用户端-&gt;[数据库]: 发起结算
[批处理]--&gt;[批处理]: 发起结算、向银行请求数据、进入结算中状态
[批处理]--&gt;[批处理]: 判断结算申请的结果、
[批处理]--&gt;[数据库]: 结算成功/结算失败 -&gt; 更新状态
[数据库]-&gt;[数据库]: 服务结束时间判断
用户端--&gt;护工端: 订单结算
护工端--&gt;[数据库]: 服务结算
POS机--&gt;用户端: 订单强制结算
POS机--&gt;护工端: 订单强制结算
用户端-&gt;[数据库]:用户评价、状态进入已评价状态
```


## 后台批处理接口说明

### 01. 支付超时的处理
-  [http://localhost:8081/api/schd/orderCancelUnpaid](#)
&gt; 说明：
    1 清理超过2小时的订单未支付的订单
	2 订单变更的处理，当2个小时内不支付，已经申请变更的订单自动变成过期未支付状态
    3 每天 8-20点之间，每分钟执行


### 02. 订单变更审核超时的处理
-  [http://localhost:8081/api/schd/cancelUnaplyToUnPayOrd](#)
&gt; 说明：
	1 次日生效 24小时后 不审批 取消并且退款
	2 当日及时生效 6小时后 遍生效 取消并且退款

### 03. 订单变更待服务的处理
-  [http://localhost:8081/api/schd/orderChangeSerStart](#)
&gt; 说明：
	1 修改变更服务变成待服务(立即执行) 没有支付的订单变更
	2 只有审批通过的变更待服务才能进入服务状态，否者停留在永远待服务的状态
    3 每分钟执行

### 04. 退款给用户的处理（微信）
-  [http://localhost:8081/api/schd/orderRefundToUser](#)
&gt; 说明：
	1 判断订单状态为7，立即退款给用户
    2 每分钟执行

### 05. 退款给用户的处理（银联）
-  [http://localhost:8081/api/schd/doRefundToUserUpay](#)
&gt; 说明：
	1 判断订单状态为7，立即退款给用户
    2 每分钟执行

### 06. 待服务进入服务中(无需支付)
-  [http://localhost:8081/api/schd/orderWaitSerToSer](#)
&gt; 说明：
	1 订单支付成功2小时后，待服务进入服务中
    2 每分钟执行，订单支付时间到当前时间有2小时的订单


### 07. 变更待服务进入服务中(有支付)
-  [http://localhost:8081/api/schd/orderChangeWaitSerToSer](#)
&gt; 说明：
	1 变更订单的等待状态变成开始服务 有支付状态的订单变更
	2 只有审批通过的变更待服务才能进入服务状态，否者停留在永远待服务的状态
    3 每分钟执行，订单支付时间到当前时间有2小时的订单


### 08. 订单拆分
-  [http://localhost:8081/api/schd/finSplitSttle](#)
&gt; 说明：
    1 针对每个订单的拆分细则，拆分 护工工资、平台费、科室费、保险费、公司所得等费用

### 09. 分账给护工站
-  [http://localhost:8081/api/schd/finInvoiceToStatn](#)
&gt; 说明：
    1 针对每个订单的拆分细则，拆分 护工工资、平台费、科室费、保险费、公司所得等费用到具体的护工站

### 10. 日结脚本
-  [http://localhost:8081/api/schd/ordDayStt](#)
&gt; 说明：
    1 针对每个订单做当日结算，消耗当天费用，并且拆分 护工工资、平台费、科室费、保险费、公司所得等费用
    2 每天12:30 23:30 跑该脚本

### 11. 护工工资结算改变状态脚本
-  [http://localhost:8081/api/schd/doSettleWrkfee](#)
&gt; 说明：
    1 根据日结结果，计算每日护工工资
    2 每天1点15分 跑该脚本

### 12. 订单逾期脚本
-  [http://localhost:8081/api/schd/ordFinishStt](#)
&gt; 说明：
    1 结算到期订单用户未点击的订单 ，结算成逾期，并且释放床位
    2 每天1点30分 跑该脚本


### 13. 订单结算状态脚本
-  [http://localhost:8081/api/schd/doSttlement](#)
&gt; 说明：
    1 对于用户已经点击结算，护工已经点击结束服务的订单，跑的脚本
    2 分钟跑该脚本</content><author><name>kei gosling</name></author><summary type="html">01. 订单与结算逻辑.结算与支付</summary></entry><entry><title type="html">订单减免</title><link href="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E5%87%8F%E5%85%8D/" rel="alternate" type="text/html" title="订单减免" /><published>2020-10-03T00:00:00+08:00</published><updated>2020-10-03T00:00:00+08:00</updated><id>https://thefirstwind.github.io//%E8%AE%A2%E5%8D%95%E5%87%8F%E5%85%8D</id><content type="html" xml:base="https://thefirstwind.github.io//2020-10-03-%E8%AE%A2%E5%8D%95%E5%87%8F%E5%85%8D/">qo_ord


订单减免相关业务的设计





### 订单主表  qord.qo_ord
```
说明：
1 修改条件：POS机代下单的时候，如果有优惠金额， discfg 和 discamount将发生变化
2 当有优惠的时候，影响的字段只有 discfg和 discamount
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| orduid|String|必须| 订单号|ORD_i7E_eQjRrXGKbYPscFqg7iOlsgK7|
| amount|Integer|必须| 订单初始预收金额| 90000|
| discfg|String|必须| 优惠标识discfg：0:无优惠，1：全免，2:减免医院管理费，3：减免公司收入，4：减免增收,5:团队制减免| 1，2，3，4 |
| discamount|Integer|必须| 优惠金额| 100 |


### 订单价格表 qord.qo_statn_item
```
说明： 无
```
| 字段名      |     参数类型 | 必须 | 参数说明   | 参考值|
| :-------- | :--------|:--------| :------ |:------ |
| stimid|Integer|必须| 价格ID|332|
| statncd|String|必须| 护工站代码| 31010700052|
| statnnm|String|必须| 护工站名称| 同济医院(上海市同济大学附属同济医院)|
| price|String|必须| 价格| 10000|
| companyfee|String|必须| 平台费用| 500|
| plusfee|String|必须| 增收| 500|
| hospfee|String|必须| 医院管理费| 500|
| deptfee|Integer|必须| 科室费| 500|
| wrkfee|Integer|必须| 护工费| 8000|


### 数据字典，各个case相关的数据变化
```
说明：
```
| 优惠类型|   服务价格|  qo_ord.amount | 优惠类型&lt;br/&gt; qo_ord.discfg  | 优惠金额 &lt;br/&gt; qo_ord.discamount| 支付金额&lt;br/&gt; qo_pay_trade.amount|
| :-------- | :--------|:--------| :------ |:------ |:------ |
| 0: 无优惠 |700元| 70000 |0|0|70000|
| 1: 全免 |700元|70000| 1,2,3,4| 10000|80000|
| 2: 减免医院管理费|700元|70000| 2| 30000 |40000|
| 3: 减免公司收入、4：减免增收|700元|70000| 3,4| 20000 |50000|
| 5: 团队制减免 |1700元|170000| 5| 10000 |160000|</content><author><name>kei gosling</name></author><summary type="html">qo_ord</summary></entry><entry><title type="html">Exclude Post from Search Index</title><link href="https://thefirstwind.github.io//jekyll/2017-11-28-post-exclude-search/" rel="alternate" type="text/html" title="Exclude Post from Search Index" /><published>2017-11-28T00:00:00+08:00</published><updated>2018-02-19T21:06:00+08:00</updated><id>https://thefirstwind.github.io//jekyll/post-exclude-search</id><content type="html" xml:base="https://thefirstwind.github.io//jekyll/2017-11-28-post-exclude-search/">This post should not appear in the search index because it has the following YAML Front Matter:

```yaml
search: false
```

**Note:** `search: false` only works to exclude posts when using Lunr as a search provider.
{: .notice--info}

To exclude files when using Algolia as a search provider add an array to `algolia.files_to_exclude` in your `_config.yml`. For more configuration options be sure to check their [full documentation](https://community.algolia.com/jekyll-algolia/options.html).

```yaml
algolia:
  # Exclude more files from indexing
  files_to_exclude:
    - index.html
    - index.md
    - excluded-file.html
    - _posts/2017-11-28-post-exclude-search.md
    - subdirectory/*.html
```</content><author><name>kei gosling</name></author><category term="Jekyll" /><summary type="html">This post should not appear in the search index because it has the following YAML Front Matter:</summary></entry></feed>